
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://teldh.github.io/ekeel/docs/codebase/EKEELVideoAnnotation/media/segmentation/">
      
      
        <link rel="prev" href="../image/">
      
      
        <link rel="next" href="../video/">
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.50">
    
    
      
        <title>segmentation - EKEEL - Empowering Knowledge Extraction to Empower Learners</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.a40c8224.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Serif+Pro:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Source Serif Pro";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#segmentation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="EKEEL - Empowering Knowledge Extraction to Empower Learners" class="md-header__button md-logo" aria-label="EKEEL - Empowering Knowledge Extraction to Empower Learners" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EKEEL - Empowering Knowledge Extraction to Empower Learners
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              segmentation
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/teldh/ekeel" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../.." class="md-tabs__link">
        
  
    
  
  Homepage

      </a>
    </li>
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../prerequisites/conda/" class="md-tabs__link">
          
  
  Deploy

        </a>
      </li>
    
  

    
  

      
        
  
  
    
  
  
    
    
      
  
  
    
  
  
    
    
      
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../burst/extractor/" class="md-tabs__link">
          
  
  Codebase

        </a>
      </li>
    
  

    
  

    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../prerequisites/mkdocs/" class="md-tabs__link">
        
  
    
  
  Mkdocs

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="EKEEL - Empowering Knowledge Extraction to Empower Learners" class="md-nav__button md-logo" aria-label="EKEEL - Empowering Knowledge Extraction to Empower Learners" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    EKEEL - Empowering Knowledge Extraction to Empower Learners
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/teldh/ekeel" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Homepage
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Deploy
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Deploy
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Local
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            Local
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../prerequisites/conda/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Prerequisites
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../platforms/annotator/install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Annotator
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../platforms/augmentator/install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Augmentator
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Remote
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Remote
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../prerequisites/linux-services/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Prerequisites
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../remote/pull/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Codebase Update
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../platforms/annotator/deploy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Annotator
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../platforms/augmentator/deploy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Augmentator
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../platforms/annotator/transcriber/deploy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Transcriber
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Codebase
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Codebase
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" checked>
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    EKEELVideoAnnotation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            EKEELVideoAnnotation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1_1" id="__nav_3_1_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    burst
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_1">
            <span class="md-nav__icon md-icon"></span>
            burst
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../burst/extractor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    extractor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../burst/kleinberg/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    kleinberg
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../burst/prototype/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    prototype
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../burst/results_processor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    results_processor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../burst/weight/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    weight
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    config
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../connector/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    connector
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_4" >
        
          
          <label class="md-nav__link" for="__nav_3_1_4" id="__nav_3_1_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    database
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_4">
            <span class="md-nav__icon md-icon"></span>
            database
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../database/mongo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mongo
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_5" >
        
          
          <label class="md-nav__link" for="__nav_3_1_5" id="__nav_3_1_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    embedding
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_5">
            <span class="md-nav__icon md-icon"></span>
            embedding
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../embedding/cluster/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cluster
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../env/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    env
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_7" >
        
          
          <label class="md-nav__link" for="__nav_3_1_7" id="__nav_3_1_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    forms
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_7">
            <span class="md-nav__icon md-icon"></span>
            forms
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../forms/form/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    form
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../forms/mail/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mail
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../forms/user/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    user
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../main/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    main
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_9" checked>
        
          
          <label class="md-nav__link" for="__nav_3_1_9" id="__nav_3_1_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    media
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_9_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_1_9">
            <span class="md-nav__icon md-icon"></span>
            media
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../audio/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    audio
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../image/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    image
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    segmentation
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    segmentation
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation" class="md-nav__link">
    <span class="md-ellipsis">
      segmentation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.MAX_VIDEO_SECONDS" class="md-nav__link">
    <span class="md-ellipsis">
      MAX_VIDEO_SECONDS
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer" class="md-nav__link">
    <span class="md-ellipsis">
      VideoAnalyzer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VideoAnalyzer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.adjust_or_insert_definitions_and_indepth_times" class="md-nav__link">
    <span class="md-ellipsis">
      adjust_or_insert_definitions_and_indepth_times
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.analyze_video" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_video
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.create_thumbnails" class="md-nav__link">
    <span class="md-ellipsis">
      create_thumbnails
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.download_video" class="md-nav__link">
    <span class="md-ellipsis">
      download_video
    </span>
  </a>
  
    <nav class="md-nav" aria-label="download_video">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.download_video--note" class="md-nav__link">
    <span class="md-ellipsis">
      NOTE
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.extract_slides_title" class="md-nav__link">
    <span class="md-ellipsis">
      extract_slides_title
    </span>
  </a>
  
    <nav class="md-nav" aria-label="extract_slides_title">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.extract_slides_title--todo-improvements-now-the-analysis-is-performed-on-the-whole-list-of-sentences-but-can-be-performed" class="md-nav__link">
    <span class="md-ellipsis">
      TODO improvements: now the analysis is performed on the whole list of sentences, but can be performed:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.extract_video_id" class="md-nav__link">
    <span class="md-ellipsis">
      extract_video_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.get_extracted_text" class="md-nav__link">
    <span class="md-ellipsis">
      get_extracted_text
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.identify_language" class="md-nav__link">
    <span class="md-ellipsis">
      identify_language
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.is_slide_video" class="md-nav__link">
    <span class="md-ellipsis">
      is_slide_video
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.request_transcript" class="md-nav__link">
    <span class="md-ellipsis">
      request_transcript
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.transcript_segmentation" class="md-nav__link">
    <span class="md-ellipsis">
      transcript_segmentation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../video/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    video
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_10" >
        
          
          <label class="md-nav__link" for="__nav_3_1_10" id="__nav_3_1_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    metrics
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_10">
            <span class="md-nav__icon md-icon"></span>
            metrics
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../metrics/agreement/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    agreement
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../metrics/analysis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    analysis
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../metrics/metrics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    metrics
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_11" >
        
          
          <label class="md-nav__link" for="__nav_3_1_11" id="__nav_3_1_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    misc_unused
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_11">
            <span class="md-nav__icon md-icon"></span>
            misc_unused
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../misc_unused/Method_01/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Method_01
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../misc_unused/Method_02/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Method_02
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../misc_unused/Method_03/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Method_03
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../misc_unused/Method_04/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Method_04
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../misc_unused/skos_synonyms_query/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    skos_synonyms_query
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../misc_unused/summary/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    summary
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../misc_unused/wikipe/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    wikipe
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_12" >
        
          
          <label class="md-nav__link" for="__nav_3_1_12" id="__nav_3_1_12_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    models
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_12">
            <span class="md-nav__icon md-icon"></span>
            models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../models/xgboost_adapter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    xgboost_adapter
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_13" >
        
          
          <label class="md-nav__link" for="__nav_3_1_13" id="__nav_3_1_13_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ontology
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_13">
            <span class="md-nav__icon md-icon"></span>
            ontology
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ontology/rdf_graph/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rdf_graph
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_14" >
        
          
          <label class="md-nav__link" for="__nav_3_1_14" id="__nav_3_1_14_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    services
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_14">
            <span class="md-nav__icon md-icon"></span>
            services
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../services/NLP_API/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NLP_API
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_15" >
        
          
          <label class="md-nav__link" for="__nav_3_1_15" id="__nav_3_1_15_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    text_processor
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_15_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_15">
            <span class="md-nav__icon md-icon"></span>
            text_processor
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../text_processor/conll/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    conll
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../text_processor/locales/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    locales
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../text_processor/synonyms/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    synonyms
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../text_processor/words/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    words
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../transcribe/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    transcribe
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_17" >
        
          
          <label class="md-nav__link" for="__nav_3_1_17" id="__nav_3_1_17_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    utils
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_17_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_17">
            <span class="md-nav__icon md-icon"></span>
            utils
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/itertools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    itertools
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/structures/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    structures
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    EKEELVideoAugmentation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            EKEELVideoAugmentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_1" >
        
          
          <label class="md-nav__link" for="__nav_3_2_1" id="__nav_3_2_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    src
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_1">
            <span class="md-nav__icon md-icon"></span>
            src
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_1_1" >
        
          
          <label class="md-nav__link" for="__nav_3_2_1_1" id="__nav_3_2_1_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    flask-server
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_2_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_1_1">
            <span class="md-nav__icon md-icon"></span>
            flask-server
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../EKEELVideoAugmentation/src/flask-server/data/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    data
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../EKEELVideoAugmentation/src/flask-server/environment/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    environment
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../EKEELVideoAugmentation/src/flask-server/handle_data/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    handle_data
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../EKEELVideoAugmentation/src/flask-server/main/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    main
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../prerequisites/mkdocs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mkdocs
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation" class="md-nav__link">
    <span class="md-ellipsis">
      segmentation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.MAX_VIDEO_SECONDS" class="md-nav__link">
    <span class="md-ellipsis">
      MAX_VIDEO_SECONDS
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer" class="md-nav__link">
    <span class="md-ellipsis">
      VideoAnalyzer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VideoAnalyzer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.adjust_or_insert_definitions_and_indepth_times" class="md-nav__link">
    <span class="md-ellipsis">
      adjust_or_insert_definitions_and_indepth_times
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.analyze_video" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_video
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.create_thumbnails" class="md-nav__link">
    <span class="md-ellipsis">
      create_thumbnails
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.download_video" class="md-nav__link">
    <span class="md-ellipsis">
      download_video
    </span>
  </a>
  
    <nav class="md-nav" aria-label="download_video">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.download_video--note" class="md-nav__link">
    <span class="md-ellipsis">
      NOTE
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.extract_slides_title" class="md-nav__link">
    <span class="md-ellipsis">
      extract_slides_title
    </span>
  </a>
  
    <nav class="md-nav" aria-label="extract_slides_title">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.extract_slides_title--todo-improvements-now-the-analysis-is-performed-on-the-whole-list-of-sentences-but-can-be-performed" class="md-nav__link">
    <span class="md-ellipsis">
      TODO improvements: now the analysis is performed on the whole list of sentences, but can be performed:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.extract_video_id" class="md-nav__link">
    <span class="md-ellipsis">
      extract_video_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.get_extracted_text" class="md-nav__link">
    <span class="md-ellipsis">
      get_extracted_text
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.identify_language" class="md-nav__link">
    <span class="md-ellipsis">
      identify_language
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.is_slide_video" class="md-nav__link">
    <span class="md-ellipsis">
      is_slide_video
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.request_transcript" class="md-nav__link">
    <span class="md-ellipsis">
      request_transcript
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.transcript_segmentation" class="md-nav__link">
    <span class="md-ellipsis">
      transcript_segmentation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<div><h1 id="segmentation">Segmentation</h1>
<hr>


<div class="doc doc-object doc-module">



<a id="/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation"></a>
    <div class="doc doc-contents first">








  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h2 id="/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.MAX_VIDEO_SECONDS" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">MAX_VIDEO_SECONDS</span> <span class="o">=</span> <span class="mi">18000</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>variables to consider:
    * punctuator net,
    * bert model,
    * cosine similarity threshold - c_threshold,
    * summary model - bert vs sumy,
    * min time to merge short clusters,
    * add_sentence vs deprecated,
    * color_histogram threshold and frame range,</p>
    </div>

</div>


<div class="doc doc-object doc-class">



<h2 id="/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer" class="doc doc-heading">
            <code>VideoAnalyzer</code>


</h2>


    <div class="doc doc-contents ">


        <p>This class analyzes videos from their ids in the path "<strong>class</strong>"-path/static/videos </p>
<p>_testing_path is for changing the folder path but it's used just for testing</p>
<pre><code>- It provides a method to get the transcript from the youtube link associated to the id provided

- segment the transcript to obtain keyframes

- Analyze the whole video stream or frames to segment slides,text and times on screen of those

- Get the extracted text in different formats (tipically only one is used and the others are for debug)

- Check if the video contains slides (for now this means text around the center of the screen) and the proportion with respect to the whole video len

- Extract titles from the slides found

- Create thumbnails based on the slides segmentation after having analyzed the text

- Find definitions and in-depths of concepts expressed in the title of every slide
</code></pre>
<p>checks of valid session are performed sometimes to ensure user did not want to stop analysis</p>






              <details class="quote">
                <summary>Source code in <code>EVA_apps/EKEELVideoAnnotation/media/segmentation.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  54</span>
<span class="normal">  55</span>
<span class="normal">  56</span>
<span class="normal">  57</span>
<span class="normal">  58</span>
<span class="normal">  59</span>
<span class="normal">  60</span>
<span class="normal">  61</span>
<span class="normal">  62</span>
<span class="normal">  63</span>
<span class="normal">  64</span>
<span class="normal">  65</span>
<span class="normal">  66</span>
<span class="normal">  67</span>
<span class="normal">  68</span>
<span class="normal">  69</span>
<span class="normal">  70</span>
<span class="normal">  71</span>
<span class="normal">  72</span>
<span class="normal">  73</span>
<span class="normal">  74</span>
<span class="normal">  75</span>
<span class="normal">  76</span>
<span class="normal">  77</span>
<span class="normal">  78</span>
<span class="normal">  79</span>
<span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">VideoAnalyzer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">'''</span>
<span class="sd">    This class analyzes videos from their ids in the path "__class__"-path/static/videos \n</span>
<span class="sd">    _testing_path is for changing the folder path but it's used just for testing\n\n</span>
<span class="sd">        - It provides a method to get the transcript from the youtube link associated to the id provided\n</span>
<span class="sd">        - segment the transcript to obtain keyframes\n</span>
<span class="sd">        - Analyze the whole video stream or frames to segment slides,text and times on screen of those\n</span>
<span class="sd">        - Get the extracted text in different formats (tipically only one is used and the others are for debug)\n</span>
<span class="sd">        - Check if the video contains slides (for now this means text around the center of the screen) and the proportion with respect to the whole video len\n</span>
<span class="sd">        - Extract titles from the slides found\n</span>
<span class="sd">        - Create thumbnails based on the slides segmentation after having analyzed the text\n</span>
<span class="sd">        - Find definitions and in-depths of concepts expressed in the title of every slide</span>
<span class="sd">    checks of valid session are performed sometimes to ensure user did not want to stop analysis</span>
<span class="sd">    '''</span>
    <span class="n">url</span><span class="p">:</span><span class="nb">str</span>
    <span class="n">video_id</span><span class="p">:</span><span class="nb">str</span>
    <span class="n">images_path</span><span class="p">:</span><span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">data</span><span class="p">:</span><span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">timed_subtitles</span><span class="p">:</span><span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">_text_in_video</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">VideoSlide</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_cos_sim_img_threshold</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_frames_to_analyze</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_slide_startends</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_slide_titles</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">request_fields_from_db</span><span class="p">:</span><span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">_testing_path</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_youtube_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">standardize_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">video_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_video_id</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"This is not a Youtube video!"</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">"Video non disponibile"</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span> <span class="ow">or</span> <span class="s2">"Video unavailable"</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Video unavailable"</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">get_video_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">,</span> <span class="n">request_fields_from_db</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'video_id'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">,</span>
                         <span class="s1">'title'</span><span class="p">:</span> <span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">'"title":"(.*?)"'</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                         <span class="s1">'creator'</span><span class="p">:</span> <span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">'"ownerChannelName":"(.*?)"'</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                         <span class="s1">'duration'</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">'"approxDurationMs":"(\d+)"'</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
                         <span class="s1">'upload_date'</span><span class="p">:</span> <span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">'"uploadDate":"(.*?)"'</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identify_language</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"duration"</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">MAX_VIDEO_SECONDS</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"The video is too long, please choose another video."</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">_testing_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">folder_path</span> <span class="o">=</span> <span class="n">VIDEOS_PATH</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">folder_path</span> <span class="o">=</span> <span class="n">_testing_path</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">standardize_url</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">'(?:=|\/|&amp;)([A-Za-z0-9_\-]</span><span class="si">{11}</span><span class="s1">)(?=[=/&amp;]|\b)'</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span><span class="n">url</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="s2">"https://www.youtube.com/watch?v="</span><span class="o">+</span><span class="nb">id</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_youtube_url</span><span class="p">(</span><span class="n">url</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">youtube_video_regex</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">r</span><span class="s1">'(https?://)?(www\.)?'</span>
            <span class="s1">'(youtube|youtu|youtube-nocookie)\.(com|be)/'</span>
            <span class="s1">'(watch\?v=|embed/|v/|.+\?v=)?([^&amp;=%\?]</span><span class="si">{11}</span><span class="s1">)'</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">match</span><span class="p">(</span><span class="n">youtube_video_regex</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">extract_video_id</span><span class="p">(</span><span class="n">url</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">'''</span>
<span class="sd">        From a YouTube url extracts the video id</span>
<span class="sd">        '''</span>
        <span class="n">video_link</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'&amp;'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">'='</span> <span class="ow">in</span> <span class="n">video_link</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">video_link</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'='</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">video_link</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">download_video</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">'''</span>
<span class="sd">        Downloads the video (expected YouTube video)\n</span>
<span class="sd">        If the video has been removed from youtube, it attempts to remove the folder from both the drive and the database, then raises an Exception\n</span>

<span class="sd">        --------------</span>
<span class="sd">        # NOTE</span>
<span class="sd">        There are problems very often with YouTube, which breaks yt_dlp library.\n </span>
<span class="sd">        In case of errors try to update the library</span>
<span class="sd">        '''</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span>
        <span class="c1">#video_link = url.split('&amp;')[0]</span>
        <span class="n">video_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_id</span>
        <span class="n">folder_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder_path</span>

        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span><span class="n">video_id</span><span class="o">+</span><span class="s1">'.mp4'</span><span class="p">)):</span>
            <span class="k">return</span>

        <span class="c1"># Both pafy and pytube seems to be not mantained anymore, only youtube_dlp is still alive</span>

        <span class="n">prev_cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#print("using ytdl")</span>
            <span class="c1">#yt_dlp.YoutubeDL({'format': 'bestvideo[height&lt;=480]', 'quiet': True}).download([url])</span>
            <span class="n">yt_dlp</span><span class="o">.</span><span class="n">YoutubeDL</span><span class="p">({</span>  <span class="s1">'quiet'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="s1">'format'</span><span class="p">:</span> <span class="s1">'bestvideo[height&lt;=720]+bestaudio/best[height&lt;=720]'</span><span class="p">,</span>
                                <span class="s1">'outtmpl'</span><span class="p">:</span> <span class="n">video_id</span><span class="o">+</span><span class="s1">'.mp4'</span><span class="p">,</span>
                                <span class="s1">'merge_output_format'</span><span class="p">:</span> <span class="s1">'mp4'</span><span class="p">,</span>
                                <span class="s1">'ffmpeg_location'</span><span class="p">:</span> <span class="s1">'/usr/bin/ffmpeg'</span><span class="p">,</span>
                                <span class="s1">'postprocessors'</span><span class="p">:</span> <span class="p">[{</span>
                                    <span class="s1">'key'</span><span class="p">:</span> <span class="s1">'FFmpegVideoConvertor'</span><span class="p">,</span>
                                    <span class="s1">'preferedformat'</span><span class="p">:</span> <span class="s1">'mp4'</span><span class="p">,</span>  <span class="c1"># Ensure the output is in mp4 format</span>
                                    <span class="p">}],</span>
                                  <span class="p">})</span><span class="o">.</span><span class="n">download</span><span class="p">([</span><span class="n">url</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">prev_cwd</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".mp4"</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">folder_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">file</span><span class="p">),</span><span class="n">folder_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">video_id</span><span class="o">+</span><span class="s2">"."</span><span class="o">+</span><span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"."</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">vidcap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">folder_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">video_id</span><span class="o">+</span><span class="s2">"."</span><span class="o">+</span><span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"."</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">vidcap</span><span class="o">.</span><span class="n">isOpened</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">min</span><span class="p">((</span><span class="n">vidcap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">),</span><span class="n">vidcap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">)))</span> <span class="o">&gt;=</span> <span class="mi">360</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Video does not have enough definition to find text"</span><span class="p">)</span>
                <span class="k">break</span>


    <span class="k">def</span> <span class="nf">_create_keyframes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">start_times</span><span class="p">,</span><span class="n">end_times</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">seconds_range</span><span class="p">,</span> <span class="n">image_scale</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">create_thumbnails</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Take a list of clusters and compute the color histogram on end and start of the cluster</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cluster_list :</span>
<span class="sd">        S : scala per color histogram</span>
<span class="sd">        seconds_range : Adjust the start and end of segments based on the difference in color histograms.</span>
<span class="sd">        """</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_times</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">end_times</span><span class="p">)</span>
        <span class="n">vsm</span> <span class="o">=</span> <span class="n">VideoSpeedManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">,</span><span class="n">output_colors</span><span class="o">=</span><span class="n">COLOR_RGB</span><span class="p">)</span>
        <span class="n">vid_ref</span> <span class="o">=</span> <span class="n">vsm</span><span class="o">.</span><span class="n">vid_ref</span>
        <span class="n">vidcap</span> <span class="o">=</span> <span class="n">vid_ref</span><span class="o">.</span><span class="n">_vidcap</span>
        <span class="n">start_end_frames</span> <span class="o">=</span> <span class="p">[(</span><span class="n">vid_ref</span><span class="o">.</span><span class="n">get_num_frame_from_time</span><span class="p">(</span><span class="n">s_time</span><span class="p">),</span><span class="n">vid_ref</span><span class="o">.</span><span class="n">get_num_frame_from_time</span><span class="p">(</span><span class="n">e_time</span><span class="p">))</span> 
                                <span class="k">for</span> <span class="n">s_time</span><span class="p">,</span><span class="n">e_time</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">start_times</span><span class="p">,</span><span class="n">end_times</span><span class="p">)]</span>

        <span class="n">curr_num_frame</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">vidcap</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_POS_FRAMES</span><span class="p">,</span> <span class="n">curr_num_frame</span><span class="p">)</span>
        <span class="n">has_frame</span><span class="p">,</span><span class="n">curr_frame</span> <span class="o">=</span> <span class="n">vidcap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">next_frame_offset</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">vid_ref</span><span class="o">.</span><span class="n">get_fps</span><span class="p">()</span>
        <span class="n">summation</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">prev_hist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_diffs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">has_frame</span><span class="p">:</span>
            <span class="n">curr_frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">curr_frame</span><span class="p">,(</span><span class="mi">240</span><span class="p">,</span><span class="mi">180</span><span class="p">))</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">curr_frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2GRAY</span><span class="p">)</span>
            <span class="n">hist</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">calcHist</span><span class="p">([</span><span class="n">image</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">])</span>
            <span class="n">hist</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="n">hist</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">curr_num_frame</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="nb">bin</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hist</span><span class="p">):</span>
                    <span class="n">diff</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">bin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">prev_hist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">all_diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
                <span class="n">summation</span> <span class="o">+=</span> <span class="n">diff</span>

            <span class="n">curr_num_frame</span> <span class="o">+=</span> <span class="n">next_frame_offset</span>
            <span class="n">vidcap</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_POS_FRAMES</span><span class="p">,</span> <span class="n">curr_num_frame</span><span class="p">)</span>
            <span class="n">has_frame</span><span class="p">,</span><span class="n">curr_frame</span> <span class="o">=</span> <span class="n">vidcap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">prev_hist</span> <span class="o">=</span> <span class="n">hist</span>

            <span class="c1">#if cv2.waitKey(1) &amp; 0xFF == ord('q'):</span>
            <span class="c1">#    break</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">S</span> <span class="o">*</span> <span class="p">(</span><span class="n">summation</span> <span class="o">/</span> <span class="n">curr_num_frame</span><span class="p">)</span>

<span class="w">        </span><span class="sd">'''</span>
<span class="sd">        checking if there is a scene change within a timeframe of "seconds_range" frames from the beginning and end of each cluster.</span>
<span class="sd">        '''</span>
        <span class="n">fps</span> <span class="o">=</span> <span class="n">vid_ref</span><span class="o">.</span><span class="n">get_fps</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">j</span><span class="p">,(</span><span class="n">start_f</span><span class="p">,</span><span class="n">end_f</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">start_end_frames</span><span class="p">):</span>
            <span class="n">changes_found</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">seconds_range</span><span class="p">):</span>
                <span class="n">diffs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">start_f</span> <span class="o">/</span> <span class="n">next_frame_offset</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">end_f</span> <span class="o">/</span> <span class="n">next_frame_offset</span><span class="p">)]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">changes_found</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">diffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_diffs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">all_diffs</span><span class="p">[</span><span class="n">diffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                    <span class="n">sec</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_f</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">fps</span>
                    <span class="n">start_times</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">changes_found</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">changes_found</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">diffs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_diffs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">all_diffs</span><span class="p">[</span><span class="n">diffs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                    <span class="n">sec</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_f</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">fps</span>
                    <span class="n">end_times</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">changes_found</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">changes_found</span><span class="p">):</span> <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">create_thumbnails</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">start_times</span><span class="p">,</span> <span class="n">end_times</span><span class="p">))</span>

        <span class="c1"># saving images to show into the timeline</span>
        <span class="n">images_path</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">folder_path</span> <span class="o">=</span> <span class="n">VIDEOS_PATH</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">start_end</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">start_end_frames</span><span class="p">):</span>
            <span class="n">vidcap</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_POS_FRAMES</span><span class="p">,</span> <span class="n">start_end</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ret</span><span class="p">,</span> <span class="n">image</span> <span class="o">=</span> <span class="n">vidcap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,(</span><span class="n">array</span><span class="p">([</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">'f'</span><span class="p">)</span><span class="o">*</span><span class="n">image_scale</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
            <span class="n">name_file</span> <span class="o">=</span> <span class="n">folder_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">".jpg"</span><span class="p">)</span>
            <span class="c1">#print(saving_position)</span>
            <span class="c1">#saving_position = "videos\\" + video_id + "\\" + str(start) + ".jpg"</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">name_file</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(),</span> <span class="n">image</span><span class="p">)</span>
            <span class="n">images_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"videos/"</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_id</span> <span class="o">+</span> <span class="s2">"/"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">".jpg"</span><span class="p">)</span>
        <span class="n">vsm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1">#print(images_path)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">images_path</span> <span class="o">=</span> <span class="n">images_path</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">start_times</span><span class="p">,</span> <span class="n">end_times</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">request_transcript</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">'''</span>
<span class="sd">        Downloads the transcript associated with the video and returns also whether the transcript is automatically or manually generated \n</span>
<span class="sd">        Preferred manually generated \n</span>
<span class="sd">        Whisper transcription is implemented in transcribe.py called as external service and will replace youtube transcript for word level precision\n</span>
<span class="sd">        '''</span>

        <span class="k">if</span> <span class="s2">"transcript_data"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="c1"># moved as external service</span>
        <span class="c1">#if extract_from_audio:</span>
        <span class="c1">#    self.data["transcript_data"] = {"text": WhisperTranscriber.transcribe(self.video_id,language), </span>
        <span class="c1">#                                    "is_autogenerated": True,</span>
        <span class="c1">#                                    "is_whisper_transcribed": True }</span>
        <span class="c1">#    mongo.insert_video_data(self.data)</span>
        <span class="c1">#    return</span>


        <span class="n">language</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_language</span><span class="p">()</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"is_whisper_transcribed"</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

        <span class="n">transcripts</span> <span class="o">=</span> <span class="n">YTTranscriptApi</span><span class="o">.</span><span class="n">list_transcripts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">)</span>
        <span class="n">transcript</span><span class="p">:</span><span class="n">Transcript</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">transcript</span> <span class="o">=</span> <span class="n">transcripts</span><span class="o">.</span><span class="n">find_manually_created_transcript</span><span class="p">([</span><span class="n">language</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">][</span><span class="s2">"is_autogenerated"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">transcript</span> <span class="o">=</span> <span class="n">transcripts</span><span class="o">.</span><span class="n">find_generated_transcript</span><span class="p">([</span><span class="n">language</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">][</span><span class="s2">"is_autogenerated"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">subs_dict</span> <span class="o">=</span> <span class="n">transcript</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subs_dict</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="s2">"end"</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[</span><span class="s2">"start"</span><span class="p">]</span> <span class="o">+</span> <span class="n">sub</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"duration"</span><span class="p">)</span>

        <span class="n">timed_subtitles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">subs_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s2">"["</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="s2">"text"</span><span class="p">]:</span>
                <span class="n">word</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"word"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span>
                        <span class="s2">"start"</span><span class="p">:</span><span class="n">entry</span><span class="p">[</span><span class="s2">"start"</span><span class="p">],</span>
                        <span class="s2">"end"</span><span class="p">:</span> <span class="n">entry</span><span class="p">[</span><span class="s2">"end"</span><span class="p">]}</span>
                <span class="n">words</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">word_text</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="s2">"text"</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" "</span><span class="p">):</span>
                    <span class="n">apostrophed_words</span> <span class="o">=</span> <span class="n">word_text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"'"</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">apostrophed_words</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">word</span><span class="p">[</span><span class="s2">"word"</span><span class="p">]</span> <span class="o">=</span> <span class="n">apostrophed_words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s2">"'"</span>
                        <span class="n">words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">apostrophed_words</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">word</span><span class="p">[</span><span class="s2">"word"</span><span class="p">]</span> <span class="o">=</span> <span class="n">apostrophed_words</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
                <span class="n">segment</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'text'</span><span class="p">:</span> <span class="n">entry</span><span class="p">[</span><span class="s2">"text"</span><span class="p">],</span> 
                           <span class="s1">'start'</span><span class="p">:</span> <span class="n">entry</span><span class="p">[</span><span class="s1">'start'</span><span class="p">],</span>
                           <span class="s1">'end'</span><span class="p">:</span> <span class="n">entry</span><span class="p">[</span><span class="s1">'end'</span><span class="p">],</span>
                           <span class="s1">'words'</span><span class="p">:</span> <span class="n">words</span> <span class="p">}</span>
                <span class="n">timed_subtitles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">][</span><span class="s2">"text"</span><span class="p">]</span> <span class="o">=</span> <span class="n">timed_subtitles</span> 

        <span class="n">mongo</span><span class="o">.</span><span class="n">insert_video_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">transcript_segmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c_threshold</span><span class="o">=</span><span class="mf">0.22</span><span class="p">,</span> <span class="n">sec_min</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span> <span class="n">S</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">frame_range</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">create_thumbnails</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        :param c_threshold: threshold per la similarità tra frasi</span>
<span class="sd">        :param sec_min: se un segmento è minore di sec_min verrà unito con il successivo</span>
<span class="sd">        :param S: scala per color histogram</span>
<span class="sd">        :param frame_range: aggiustare inizio e fine dei segmenti in base a differenza nel color histogram nel frame_range</span>
<span class="sd">        :return: segments</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="s2">"video_data"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s2">"segments"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"video_data"</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> 
        <span class="n">video_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_id</span>
        <span class="n">language</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_language</span><span class="p">()</span>

        <span class="c1"># get punctuated transcription from the conll in the db</span>
        <span class="c1">#transcription:str = get_text(video_id)</span>
        <span class="c1">#if transcription is None:</span>
        <span class="c1">#    if self.timed_subtitles is None:</span>
        <span class="c1">#        self.request_transcript()</span>
<span class="c1">#</span>
        <span class="c1">#    '''Get the transcription from the subtitles'''</span>
        <span class="c1">#    transcription:str = " ".join([sub["text"] for sub in self.timed_subtitles["text"]])</span>
        <span class="c1">#    if language == Locale().get_pt1_from_full('English'):</span>
        <span class="c1">#        transcription:str = transcription.replace('\n', ' ').replace("&gt;&gt;", "") \</span>
        <span class="c1">#                                         .replace("Dr.","Dr").replace("dr.","dr") \</span>
        <span class="c1">#                                         .replace("Mr.","Mr").replace("mr.","mr")</span>
        <span class="c1">#print("Checking punctuation...")</span>
        <span class="n">semantic_transcript</span> <span class="o">=</span> <span class="n">SemanticText</span><span class="p">(</span><span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timed_sentence</span><span class="p">[</span><span class="s2">"text"</span><span class="p">]</span> <span class="k">for</span> <span class="n">timed_sentence</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">][</span><span class="s2">"text"</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="s2">"["</span> <span class="ow">in</span> <span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]),</span><span class="n">language</span><span class="p">)</span>

        <span class="c1">#video = mongo.get_video(video_id)</span>

<span class="w">        </span><span class="sd">'''Divide into sentences the punctuated transcription'''</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Extracting sentences.."</span><span class="p">)</span>
        <span class="n">sentences</span> <span class="o">=</span> <span class="p">[</span><span class="n">sent</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">" ,"</span><span class="p">,</span><span class="s2">","</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">" ."</span><span class="p">,</span><span class="s2">"."</span><span class="p">)</span> <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">semantic_transcript</span><span class="o">.</span><span class="n">tokenize</span><span class="p">()]</span>

<span class="w">        </span><span class="sd">'''For each sentence, add its start and end time obtained from the subtitles'''</span>
        <span class="n">timed_sentences</span> <span class="o">=</span> <span class="n">get_timed_sentences</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">][</span><span class="s2">"text"</span><span class="p">],</span> <span class="n">sentences</span><span class="p">)</span>

<span class="w">        </span><span class="sd">'''Define the BERT model for similarity'''</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Creating embeddings.."</span><span class="p">)</span>
        <span class="c1">#model = SentenceTransformer('paraphrase-distilroberta-base-v1')</span>
        <span class="c1">#model = SentenceTransformer('stsb-roberta-large')</span>

<span class="w">        </span><span class="sd">'''Compute a vector of numbers (the embedding) to idenfity each sentence'''</span>
        <span class="c1">#embeddings = model.encode(sentences, convert_to_tensor=True)</span>
        <span class="c1"># All moved inside semantic transcript class</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="n">semantic_transcript</span><span class="o">.</span><span class="n">get_embeddings</span><span class="p">()</span>

<span class="w">        </span><span class="sd">'''Create clusters based on semantic textual similarity, using the BERT embeddings'''</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Creating initials segments.."</span><span class="p">)</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="n">create_cluster_list</span><span class="p">(</span><span class="n">timed_sentences</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">c_threshold</span><span class="p">)</span>


<span class="w">        </span><span class="sd">'''Aggregate togheter clusters shorter than 40 seconds in total'''</span>
        <span class="n">refined_clusters</span> <span class="o">=</span> <span class="n">aggregate_short_clusters</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">sec_min</span><span class="p">)</span>

        <span class="n">start_times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">end_times</span> <span class="o">=</span> <span class="p">[]</span>

<span class="w">        </span><span class="sd">'''Print the final result'''</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">refined_clusters</span><span class="p">:</span>
            <span class="n">start_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>
            <span class="n">end_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"video_data"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"segments"</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">start_times</span><span class="p">,</span> <span class="n">end_times</span><span class="p">))}</span>
        <span class="n">mongo</span><span class="o">.</span><span class="n">insert_video_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>


        <span class="nb">print</span><span class="p">(</span><span class="s2">"Reached the part of finding clusters"</span><span class="p">)</span>

<span class="w">        </span><span class="sd">'''Find and append to each cluster the 2 most relevant sentences'''</span>
        <span class="c1">#num_sentences = 2</span>
        <span class="c1">#sumy_summary(refined_clusters, num_sentences)</span>
        <span class="c1">#self.transcript = semantic_transcript</span>


<span class="w">        </span><span class="sd">'''Adjust end and start time of each cluster based on detected scene changes'''</span>
        <span class="c1">#path = Path(__file__).parent.joinpath("static", "videos", video_id)</span>
        <span class="c1">#if not create_thumbnails:</span>
        <span class="c1">#    self.data["video_data"]['segments'] = self._create_keyframes(start_times, end_times, S, frame_range, create_thumbnails=False)</span>
        <span class="c1">#    return</span>
<span class="c1">#</span>
        <span class="c1">#if not any(File.endswith(".jpg") for File in os.listdir(path)):</span>
        <span class="c1">#    self.data["video_data"]['segments'] = self._create_keyframes(start_times, end_times, S, frame_range)</span>
        <span class="c1">#else:</span>
        <span class="c1">#    print("keyframes already present")</span>
        <span class="c1">#    images = []</span>
        <span class="c1">#    for File in os.listdir(path):</span>
        <span class="c1">#        if File.endswith(".jpg"):</span>
        <span class="c1">#            images.append(File.split(".")[0])</span>
        <span class="c1">#    images.sort(key=int)</span>
        <span class="c1">#    self.images_path = ["videos/" + video_id + "/" + im + ".jpg" for im in images]</span>
        <span class="k">return</span>


    <span class="c1">#def extract_keywords(self,maxWords:int=1,minFrequency:int=3) -&gt; None:</span>
    <span class="c1">#    video_doc = mongo.get_video_metadata(self.video_id)</span>
    <span class="c1">#    if video_doc is None:</span>
    <span class="c1">#        if self.transcript is None:</span>
    <span class="c1">#            self.transcript_segmentation_and_thumbnails(create_thumbnails=False)</span>
    <span class="c1">#        self.data["extracted_keywords"] = self.transcript.extract_keywords(maxWords, minFrequency)</span>
    <span class="c1">#        return</span>
    <span class="c1">#    self.data["extracted_keywords"] = video_doc["extracted_keywords"]</span>


<span class="c1">#######################</span>
    <span class="k">def</span> <span class="nf">_preprocess_video</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vsm</span><span class="p">:</span><span class="n">VideoSpeedManager</span><span class="p">,</span><span class="n">num_segments</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span><span class="n">estimate_threshold</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">_show_info</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">'''</span>
<span class="sd">        Split the video into `num_segments` windows frames, for every segment it's taken the frame that's far enough to guarantee a minimum sensibility\n</span>
<span class="sd">        The current frame is analyzed by XGBoost model to recognize the scene\n</span>
<span class="sd">        If there are two non-slide frames consecutively the resulting frame window is cut\n</span>
<span class="sd">        Bounds are both upper and lower inclusive to avoid a miss as much as possible\n</span>
<span class="sd">        Then both are compared in terms of cosine distance of their histograms (it's faster than flattening and computing on pure pixels)\n\n</span>
<span class="sd">        Lastly the distance between wach frame is selected as either the average of values, either with fixed value.\n</span>
<span class="sd">        In this instance with videos that are mostly static, the threshold is set to 0.9999</span>
<span class="sd">        #TODO further improvements: for more accuracy this algorithm could include frames similarity to classify a segment as slide (which is a generally very static)</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        The cosine similarity threshold and the list of frames to analyze (tuples of starting and ending frames)</span>

<span class="sd">        ----------</span>
<span class="sd">        Example</span>
<span class="sd">        ----------</span>
<span class="sd">        A video split into 10 segments:\n\n</span>
<span class="sd">        slide_segments : 0,1,3,6,9,10\n</span>
<span class="sd">        non_slide_segments : 2,4,5,7,8\n</span>
<span class="sd">        results in segmentation = [(0,4),(5,7)(8,10)]\n</span>
<span class="sd">        with holes between segments 4-5 and 7-8</span>
<span class="sd">        '''</span>
        <span class="n">num_frames</span> <span class="o">=</span> <span class="n">vsm</span><span class="o">.</span><span class="n">get_video</span><span class="p">()</span><span class="o">.</span><span class="n">get_count_frames</span><span class="p">()</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">num_frames</span> <span class="o">/</span> <span class="p">(</span><span class="n">num_segments</span><span class="p">))</span>
        <span class="n">vsm</span><span class="o">.</span><span class="n">lock_speed</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
        <span class="n">iterations_counter</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">txt_cleaner</span> <span class="o">=</span> <span class="n">TextCleaner</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">estimate_threshold</span><span class="p">:</span>
            <span class="n">cos_sim_values</span> <span class="o">=</span> <span class="n">empty</span><span class="p">((</span><span class="n">num_segments</span><span class="p">,</span><span class="n">vsm</span><span class="o">.</span><span class="n">get_video</span><span class="p">()</span><span class="o">.</span><span class="n">get_dim_frame</span><span class="p">()[</span><span class="mi">2</span><span class="p">]))</span>

        <span class="c1"># Optimization is performed by doing a first coarse-grained analysis with the XGBoost model predictor</span>
        <span class="c1"># then set those windows inside the VideoSpeedManager</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">XGBoostModelAdapter</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">"models"</span><span class="p">,</span><span class="s2">"xgboost500.sav"</span><span class="p">)</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span>
        <span class="c1">#XGBoostModelAdapter(os.path.dirname(os.path.realpath(__file__))+"/xgboost/model/xgboost500.sav")</span>

        <span class="n">start_frame_num</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">frames_to_analyze</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">answ_queue</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">])</span>
        <span class="n">curr_frame</span> <span class="o">=</span> <span class="n">ImageClassifier</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">prev_frame</span> <span class="o">=</span> <span class="n">curr_frame</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">frame_w</span><span class="p">,</span><span class="n">frame_h</span><span class="p">,</span><span class="n">num_colors</span> <span class="o">=</span> <span class="n">vsm</span><span class="o">.</span><span class="n">get_video</span><span class="p">()</span><span class="o">.</span><span class="n">get_dim_frame</span><span class="p">()</span>

        <span class="c1"># Loops through num segments and for every segment checks if is a slide</span>
        <span class="c1"># When at least one </span>
        <span class="c1"># Iterates over num segments</span>
        <span class="k">while</span> <span class="n">iterations_counter</span> <span class="o">&lt;</span> <span class="n">num_segments</span><span class="p">:</span>

            <span class="c1"># Stores two frames</span>
            <span class="n">prev_frame</span><span class="o">.</span><span class="n">set_img</span><span class="p">(</span><span class="n">vsm</span><span class="o">.</span><span class="n">get_frame</span><span class="p">())</span>
            <span class="n">curr_frame</span><span class="o">.</span><span class="n">set_img</span><span class="p">(</span><span class="n">vsm</span><span class="o">.</span><span class="n">get_following_frame</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">is_enough_slidish_like</span><span class="p">(</span><span class="n">prev_frame</span><span class="p">):</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">prev_frame</span><span class="o">.</span><span class="n">get_img</span><span class="p">()</span>

                <span class="c1"># validate slide in frame by slicing the image in a region that removes logos (that are usually in corners)</span>
                <span class="n">region</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">frame_h</span><span class="o">/</span><span class="mi">11</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">frame_h</span><span class="o">*</span><span class="mi">8</span><span class="o">/</span><span class="mi">9</span><span class="p">)),</span><span class="nb">slice</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">frame_w</span><span class="o">/</span><span class="mi">8</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">frame_w</span><span class="o">*</span><span class="mi">7</span><span class="o">/</span><span class="mi">8</span><span class="p">)))</span>
                <span class="n">prev_frame</span><span class="o">.</span><span class="n">set_img</span><span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="n">region</span><span class="p">])</span>

                <span class="c1"># double checks the text  </span>
                <span class="n">is_slide</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">txt_cleaner</span><span class="o">.</span><span class="n">clean_text</span><span class="p">(</span><span class="n">prev_frame</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span><span class="n">return_text</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="c1">#from matplotlib import pyplot as plt; plt.figure("Figure 1"); plt.imshow(frame); plt.figure("Figure 2"); plt.imshow(prev_frame.get_img())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_slide</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">answ_queue</span><span class="o">.</span><span class="n">appendleft</span><span class="p">(</span><span class="n">is_slide</span><span class="p">);</span> <span class="n">answ_queue</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

            <span class="c1"># if there's more than 1 True discontinuity -&gt; cut the video</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">answ_queue</span><span class="p">)</span> <span class="ow">and</span> <span class="n">start_frame_num</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">start_frame_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">clip</span><span class="p">(</span><span class="n">iterations_counter</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">num_segments</span><span class="p">))</span><span class="o">*</span><span class="n">step</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">answ_queue</span><span class="p">)</span> <span class="ow">and</span> <span class="n">start_frame_num</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">frames_to_analyze</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start_frame_num</span><span class="p">,(</span><span class="n">iterations_counter</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">step</span><span class="p">))</span>
                <span class="n">start_frame_num</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">estimate_threshold</span><span class="p">:</span>
                <span class="n">cos_sim_values</span><span class="p">[</span><span class="n">iterations_counter</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">prev_frame</span><span class="o">.</span><span class="n">get_cosine_similarity</span><span class="p">(</span><span class="n">curr_frame</span><span class="p">)</span>
            <span class="n">iterations_counter</span><span class="o">+=</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">_show_info</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" Coarse-grained analysis: </span><span class="si">{</span><span class="n">ceil</span><span class="p">((</span><span class="n">iterations_counter</span><span class="p">)</span><span class="o">/</span><span class="n">num_segments</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">%"</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s1">'</span><span class="se">\r</span><span class="s1">'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start_frame_num</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">frames_to_analyze</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start_frame_num</span><span class="p">,</span><span class="n">num_frames</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">estimate_threshold</span><span class="p">:</span>
            <span class="n">cos_sim_img_threshold</span> <span class="o">=</span> <span class="n">clip</span><span class="p">(</span><span class="n">average</span><span class="p">(</span><span class="n">cos_sim_values</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">var</span><span class="p">(</span><span class="n">cos_sim_values</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">0.9999</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cos_sim_img_threshold</span> <span class="o">=</span> <span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">num_colors</span><span class="p">))</span><span class="o">*</span><span class="mf">0.9999</span>

        <span class="k">if</span> <span class="n">_show_info</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">estimate_threshold</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Estimated cosine similarity threshold: </span><span class="si">{</span><span class="n">cos_sim_img_threshold</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Cosine_similarity threshold: </span><span class="si">{</span><span class="n">cos_sim_img_threshold</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Frames to analyze: </span><span class="si">{</span><span class="n">frames_to_analyze</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">num_frames</span><span class="si">}</span><span class="s2"> total frames"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"video_data"</span><span class="p">][</span><span class="s2">"slides_percentage"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">frame_window</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">frame_window</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">frame_window</span> <span class="ow">in</span> <span class="n">frames_to_analyze</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">num_frames</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cos_sim_img_threshold</span> <span class="o">=</span> <span class="n">cos_sim_img_threshold</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">_frames_to_analyze</span> <span class="o">=</span> <span class="n">frames_to_analyze</span>    


    <span class="k">def</span> <span class="nf">analyze_video</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">_show_info</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Analyzes a video to identify and extract slides, transitioning between different states </span>
<span class="sd">        (WAITING_OPENING, OPENING, CONTENT, ENDED) based on the content of the video frames.</span>
<span class="sd">        It's based on the EduOpen format, so it will look for the logo and start looking for the text using a state machine based algorithm</span>

<span class="sd">        Parameters:</span>
<span class="sd">        _show_info (bool): Flag to control the display of processing information. Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">        None</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_slide_video</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">"slides"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"video_data"</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="k">class</span> <span class="nc">State</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
            <span class="n">WAITING_OPENING</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
            <span class="n">OPENING</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
            <span class="n">CONTENT</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
            <span class="n">ENDED</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>


        <span class="n">video</span> <span class="o">=</span> <span class="n">SimpleVideo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">)</span>
        <span class="n">video</span><span class="o">.</span><span class="n">set_step</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get_fps</span><span class="p">())</span>

        <span class="n">slides</span><span class="p">:</span><span class="nb">list</span><span class="p">[</span><span class="n">VideoSlide</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># We start looking for EduOpen</span>
        <span class="c1"># Then transit to content</span>
        <span class="c1"># Ending is optional (sometimes videos are cut)</span>
        <span class="n">state_machine</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"state"</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">State</span><span class="p">)[</span><span class="mi">0</span><span class="p">]}</span>
        <span class="n">next_state</span> <span class="o">=</span> <span class="p">{</span> <span class="n">from_state</span><span class="p">:</span><span class="n">to_state</span> <span class="k">for</span> <span class="n">from_state</span><span class="p">,</span> <span class="n">to_state</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">State</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">State</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="kc">None</span><span class="p">]))</span> <span class="p">}</span>
        <span class="n">prev_frame</span> <span class="o">=</span> <span class="n">ImageClassifier</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get_frame</span><span class="p">())</span>
        <span class="n">curr_frame</span> <span class="o">=</span> <span class="n">prev_frame</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">speed_up_coef</span> <span class="o">=</span> <span class="mf">0.35</span>
        <span class="n">fps</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">get_fps</span><span class="p">()</span>
        <span class="n">max_speed</span> <span class="o">=</span> <span class="n">fps</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="n">curr_slide</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>

            <span class="c1"># We have finished</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">curr_frame</span><span class="o">.</span><span class="n">has_image</span><span class="p">():</span>
                <span class="n">state_machine</span><span class="p">[</span><span class="s2">"state"</span><span class="p">]</span> <span class="o">=</span> <span class="n">State</span><span class="o">.</span><span class="n">ENDED</span>

            <span class="n">curr_state</span> <span class="o">=</span> <span class="n">state_machine</span><span class="p">[</span><span class="s1">'state'</span><span class="p">]</span>

            <span class="c1"># We are looking for the edu (o) pen word (the o is not recognized)</span>
            <span class="k">if</span> <span class="n">curr_state</span> <span class="o">==</span> <span class="n">State</span><span class="o">.</span><span class="n">WAITING_OPENING</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">curr_frame</span><span class="o">.</span><span class="n">is_same_image</span><span class="p">(</span><span class="n">prev_frame</span><span class="p">):</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">curr_frame</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span><span class="n">return_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s2">"edu"</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="s2">"pen"</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                        <span class="n">state_machine</span><span class="p">[</span><span class="s2">"state"</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_state</span><span class="p">[</span><span class="n">curr_state</span><span class="p">]</span>
                        <span class="n">video</span><span class="o">.</span><span class="n">set_step</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get_fps</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">video</span><span class="o">.</span><span class="n">set_step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">_curr_step</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">video</span><span class="o">.</span><span class="n">get_fps</span><span class="p">()</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>

            <span class="c1"># We are looking in a change in the text that won't have edu and open in the text</span>
            <span class="k">elif</span> <span class="n">curr_state</span> <span class="o">==</span> <span class="n">State</span><span class="o">.</span><span class="n">OPENING</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">curr_frame</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span><span class="n">return_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="s2">"edu"</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">or</span> <span class="ow">not</span> <span class="s2">"pen"</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="p">:</span>
                    <span class="n">state_machine</span><span class="p">[</span><span class="s1">'state'</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_state</span><span class="p">[</span><span class="n">curr_state</span><span class="p">]</span>

            <span class="c1"># We start processing slides reading the text at increasing video speed (capped at max speed) </span>
            <span class="c1"># as we find same text in the image</span>
            <span class="k">elif</span> <span class="n">curr_state</span> <span class="o">==</span> <span class="n">State</span><span class="o">.</span><span class="n">CONTENT</span><span class="p">:</span>
                <span class="n">texts_with_bb</span> <span class="o">=</span> <span class="n">curr_frame</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span><span class="n">return_text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_contours</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Found text</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">texts_with_bb</span><span class="p">):</span>

                    <span class="c1"># Create new slide</span>
                    <span class="k">if</span> <span class="n">curr_slide</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">curr_slide</span> <span class="o">=</span> <span class="n">VideoSlide</span><span class="p">(</span><span class="n">texts_with_bb</span><span class="p">,</span> <span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get_frame_index</span><span class="p">(),</span> <span class="kc">None</span><span class="p">))</span>

                    <span class="c1"># Check if it's the same slide as the one cached</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_slide</span> <span class="o">=</span> <span class="n">VideoSlide</span><span class="p">(</span><span class="n">texts_with_bb</span><span class="p">,</span> <span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get_frame_index</span><span class="p">(),</span><span class="kc">None</span><span class="p">))</span>

                        <span class="c1"># If different append the previous slide setting it's end and reset the playback speed</span>
                        <span class="k">if</span> <span class="n">new_slide</span> <span class="o">!=</span> <span class="n">curr_slide</span><span class="p">:</span>
                            <span class="n">curr_slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">curr_slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">video</span><span class="o">.</span><span class="n">get_frame_index</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
                            <span class="n">slides</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_slide</span><span class="p">)</span>
                            <span class="n">curr_slide</span> <span class="o">=</span> <span class="n">new_slide</span>
                            <span class="n">video</span><span class="o">.</span><span class="n">set_step</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get_fps</span><span class="p">()</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>

                        <span class="c1"># If same slide increase playback speed</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">video</span><span class="o">.</span><span class="n">set_step</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">_curr_step</span> <span class="o">+</span> <span class="n">speed_up_coef</span> <span class="o">*</span> <span class="n">max_speed</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_speed</span><span class="p">)))</span>

                <span class="c1"># Not found text</span>
                <span class="k">else</span><span class="p">:</span>

                    <span class="c1"># If there is a slide save it, set it's end and reset playback speed</span>
                    <span class="k">if</span> <span class="n">curr_slide</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">curr_slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">curr_slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">video</span><span class="o">.</span><span class="n">get_frame_index</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
                        <span class="n">slides</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_slide</span><span class="p">)</span>
                        <span class="n">curr_slide</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">video</span><span class="o">.</span><span class="n">set_step</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get_fps</span><span class="p">()</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># If the last slide has not an end_frame because the video ended before, we assign last frame</span>
            <span class="k">elif</span> <span class="n">curr_state</span> <span class="o">==</span> <span class="n">State</span><span class="o">.</span><span class="n">ENDED</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">curr_slide</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">slides</span><span class="p">)</span> <span class="ow">and</span> <span class="n">curr_slide</span> <span class="o">!=</span> <span class="n">slides</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">curr_slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">curr_slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">video</span><span class="o">.</span><span class="n">get_frame_index</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
                    <span class="n">slides</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_slide</span><span class="p">)</span>
                <span class="k">break</span>   

            <span class="n">prev_frame</span><span class="o">.</span><span class="n">set_img</span><span class="p">(</span><span class="n">curr_frame</span><span class="o">.</span><span class="n">get_img</span><span class="p">())</span>
            <span class="n">curr_frame</span><span class="o">.</span><span class="n">set_img</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get_frame</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">_show_info</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Doing </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">video</span><span class="o">.</span><span class="n">_curr_frame_idx</span><span class="o">-</span><span class="n">video</span><span class="o">.</span><span class="n">_curr_step</span><span class="p">)</span><span class="o">/</span><span class="n">video</span><span class="o">.</span><span class="n">get_count_frames</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">%  curr step </span><span class="si">{</span><span class="n">video</span><span class="o">.</span><span class="n">_curr_step</span><span class="si">}</span><span class="s2"> num slides </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">slides</span><span class="p">)</span><span class="si">}</span><span class="s2">    "</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s2">"</span><span class="se">\r</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Cleaning doubles</span>
        <span class="c1"># TODO need to implement method to remove gibberish</span>
        <span class="n">txt_classif</span> <span class="o">=</span> <span class="n">TextSimilarityClassifier</span><span class="p">(</span><span class="n">comp_methods</span><span class="o">=</span><span class="p">{</span><span class="n">ComparisonMethods</span><span class="o">.</span><span class="n">FUZZY_PARTIAL_RATIO</span><span class="p">,</span> <span class="n">ComparisonMethods</span><span class="o">.</span><span class="n">CHARS_COMMON_DISTRIB</span><span class="p">})</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">n_iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">changed</span><span class="p">:</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">to_reverse</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">slide1</span><span class="p">,</span><span class="n">slide2</span> <span class="ow">in</span> <span class="n">pairwise</span><span class="p">(</span><span class="n">slides</span><span class="p">,</span> <span class="n">None_tail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">reversed</span><span class="o">=</span><span class="n">to_reverse</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">txt_classif</span><span class="o">.</span><span class="n">is_partially_in</span><span class="p">(</span><span class="n">slide1</span><span class="p">,</span><span class="n">slide2</span><span class="p">):</span>
                        <span class="n">slide2</span><span class="p">:</span><span class="n">VideoSlide</span>
                        <span class="n">slide2</span><span class="o">.</span><span class="n">merge_frames</span><span class="p">(</span><span class="n">slide1</span><span class="p">)</span>
                        <span class="n">slides</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">slide1</span><span class="p">)</span>
                        <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">n_iter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">slide1</span><span class="p">,</span> <span class="n">slide2</span> <span class="ow">in</span> <span class="n">double_iterator</span><span class="p">(</span><span class="n">slides</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">txt_classif</span><span class="o">.</span><span class="n">is_partially_in</span><span class="p">(</span><span class="n">slide2</span><span class="p">,</span><span class="n">slide1</span><span class="p">):</span>
                    <span class="n">slide1</span><span class="p">:</span><span class="n">VideoSlide</span>
                    <span class="n">slide1</span><span class="o">.</span><span class="n">merge_frames</span><span class="p">(</span><span class="n">slide2</span><span class="p">)</span>
                    <span class="n">slides</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">slide2</span><span class="p">)</span>
                    <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">n_iter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Now correct slides offsets to the first and last frame they appear</span>
        <span class="c1"># TODO need to implement binary search because it's too slow</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">=</span> <span class="n">fps</span><span class="o">//</span><span class="mi">5</span>
            <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">)</span> <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">slides</span><span class="p">])</span>
            <span class="n">iter_</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">slides</span><span class="p">:</span>
                <span class="n">this_slide_text</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">_full_text</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">start_frame</span><span class="p">,</span> <span class="n">end_frame</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">):</span>

                    <span class="c1"># Shifting start frame backward</span>
                    <span class="n">video</span><span class="o">.</span><span class="n">rewind</span><span class="p">()</span>
                    <span class="n">video</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">start_frame</span><span class="p">)</span>
                    <span class="n">video</span><span class="o">.</span><span class="n">set_step</span><span class="p">(</span><span class="o">-</span><span class="n">step</span><span class="p">)</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">other_frame_text</span> <span class="o">=</span> <span class="n">curr_frame</span><span class="o">.</span><span class="n">set_img</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get_frame</span><span class="p">())</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span><span class="n">return_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start_frame</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> \
                           <span class="p">(</span><span class="n">this_slide_text</span> <span class="o">!=</span> <span class="n">other_frame_text</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">slide</span><span class="o">.</span><span class="n">txt_sim_class</span><span class="o">.</span><span class="n">are_cosine_similar</span><span class="p">(</span><span class="n">this_slide_text</span><span class="p">,</span> <span class="n">other_frame_text</span><span class="p">,</span><span class="n">confidence</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)):</span>
                            <span class="n">start_frame</span> <span class="o">+=</span> <span class="n">step</span>
                            <span class="k">break</span>

                        <span class="n">start_frame</span> <span class="o">-=</span> <span class="n">step</span>

                    <span class="c1"># Shifting end frame forward</span>
                    <span class="n">video</span><span class="o">.</span><span class="n">rewind</span><span class="p">()</span>
                    <span class="n">video</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">end_frame</span><span class="p">)</span>
                    <span class="n">video</span><span class="o">.</span><span class="n">set_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">other_frame_text</span> <span class="o">=</span> <span class="n">curr_frame</span><span class="o">.</span><span class="n">set_img</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get_frame</span><span class="p">())</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span><span class="n">return_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">)</span> <span class="ow">and</span> <span class="n">slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">end_frame</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> \
                           <span class="p">(</span><span class="n">this_slide_text</span> <span class="o">!=</span> <span class="n">other_frame_text</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">slide</span><span class="o">.</span><span class="n">txt_sim_class</span><span class="o">.</span><span class="n">are_cosine_similar</span><span class="p">(</span><span class="n">this_slide_text</span><span class="p">,</span> <span class="n">other_frame_text</span><span class="p">,</span><span class="n">confidence</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)):</span>
                            <span class="n">end_frame</span> <span class="o">-=</span> <span class="n">step</span>
                            <span class="k">break</span>

                        <span class="n">end_frame</span> <span class="o">+=</span> <span class="n">step</span>

                    <span class="n">iter_</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"At </span><span class="si">{</span><span class="n">iter_</span><span class="o">/</span><span class="n">total</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">%"</span><span class="p">)</span>
                    <span class="c1"># We reassign the frames</span>
                    <span class="n">slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_frame</span><span class="p">,</span> <span class="n">end_frame</span><span class="p">)</span>

        <span class="c1"># Convert into seconds</span>
        <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">slides</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">start_frame</span><span class="p">,</span> <span class="n">end_frame</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">):</span>
                <span class="n">slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_frame</span><span class="o">/</span><span class="n">fps</span><span class="p">,</span> <span class="n">end_frame</span><span class="o">/</span><span class="n">fps</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"video_data"</span><span class="p">][</span><span class="s2">"slides"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">tft</span><span class="p">)</span> <span class="k">for</span> <span class="n">tft</span> <span class="ow">in</span> <span class="n">slides</span><span class="p">]</span>

        <span class="n">mongo</span><span class="o">.</span><span class="n">insert_video_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>


<span class="c1">#######################</span>


<span class="c1">############ New Methods ###########</span>
    <span class="k">def</span> <span class="nf">identify_language</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span><span class="n">Literal</span><span class="p">[</span><span class="s1">'full'</span><span class="p">,</span><span class="s1">'pt1'</span><span class="p">]</span><span class="o">=</span><span class="s1">'pt1'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">'''</span>
<span class="sd">        Recognizes the video language (currently implemented ita and eng so it raises exception if not one of these)</span>
<span class="sd">        '''</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">'language'</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'language'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">YTTranscriptApi</span><span class="o">.</span><span class="n">list_transcripts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">)</span><span class="o">.</span><span class="n">_generated_transcripts</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> 

        <span class="n">locale</span> <span class="o">=</span> <span class="n">Locale</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">locale</span><span class="o">.</span><span class="n">is_language_supported</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'language'</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Language is not between supported ones: </span><span class="si">{</span><span class="n">locale</span><span class="o">.</span><span class="n">get_supported_languages</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'language'</span><span class="p">]</span> <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span><span class="s1">'pt1'</span> <span class="k">else</span> <span class="n">locale</span><span class="o">.</span><span class="n">get_full_from_pt1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'language'</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">analyze_transcript</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_debug_reload_from_json</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1">#assert self.identify_language() == "it", "implementation error cannot analyze other language transcripts here"</span>
        <span class="k">if</span> <span class="n">_debug_reload_from_json</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"ItaliaNLP_doc_id"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
            <span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">load</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">VIDEOS_PATH</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="o">+</span><span class="s2">".json"</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">][</span><span class="s2">"text"</span><span class="p">]</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="s2">"segments"</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">"ItaliaNLP_doc_id"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">timed_transcript</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">][</span><span class="s2">"text"</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>        
        <span class="n">language</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_language</span><span class="p">()</span>
        <span class="n">doc_id</span><span class="p">,</span> <span class="n">tagged_transcript</span> <span class="o">=</span> <span class="n">WhisperToPosTagged</span><span class="p">(</span><span class="n">language</span><span class="p">)</span><span class="o">.</span><span class="n">request_tagged_transcript</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">,</span> <span class="n">timed_transcript</span><span class="p">)</span>

        <span class="c1">#with open("transcript.json","w") as f:</span>
        <span class="c1">#    json.dump({"transcript": self.data["transcript_data"]["text"], "lemmas": self.data["transcript_data"]["lemmas"]},f,indent=4)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">][</span><span class="s2">"text"</span><span class="p">]</span> <span class="o">=</span> <span class="n">tagged_transcript</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span> <span class="s2">"ItaliaNLP_doc_id"</span><span class="p">:</span>   <span class="n">doc_id</span> <span class="p">})</span>

        <span class="n">mongo</span><span class="o">.</span><span class="n">insert_video_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_debug_recompute</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_debug_recompute</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">"terms"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">][</span><span class="s2">"terms"</span><span class="p">]):</span>
                <span class="k">return</span>

        <span class="n">language</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_language</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">language</span> <span class="o">==</span> <span class="s2">"it"</span><span class="p">:</span>
            <span class="n">terms</span> <span class="o">=</span> <span class="n">ItaliaNLAPI</span><span class="p">()</span><span class="o">.</span><span class="n">execute_term_extraction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">][</span><span class="s2">"ItaliaNLP_doc_id"</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">language</span> <span class="o">==</span> <span class="s2">"en"</span><span class="p">:</span>
            <span class="n">terms</span> <span class="o">=</span> <span class="n">extract_keywords_LEGACY</span><span class="p">(</span><span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timed_sentence</span><span class="p">[</span><span class="s2">"text"</span><span class="p">]</span> <span class="k">for</span> <span class="n">timed_sentence</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">][</span><span class="s2">"text"</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="s2">"["</span> <span class="ow">in</span> <span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">"terms"</span><span class="p">:</span> <span class="n">terms</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">'records'</span><span class="p">)})</span>
        <span class="n">mongo</span><span class="o">.</span><span class="n">insert_video_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">filter_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filtering_opts</span><span class="p">:</span><span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">filtering_opts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filtering_opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"domain_relevance_thresh"</span><span class="p">:</span> <span class="mi">80</span><span class="p">}</span>
        <span class="n">terms</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">][</span><span class="s2">"terms"</span><span class="p">])</span> 
        <span class="k">if</span> <span class="n">terms</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">terms</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"term"</span><span class="p">,</span> <span class="s2">"domain_relevance"</span><span class="p">,</span> <span class="s2">"frequency"</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">][</span><span class="s2">"terms"</span><span class="p">]</span> <span class="o">=</span> <span class="n">terms</span><span class="p">[</span><span class="n">terms</span><span class="p">[</span><span class="s2">"domain_relevance"</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">filtering_opts</span><span class="p">[</span><span class="s2">"domain_relevance_thresh"</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">"records"</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">lemmatize_an_italian_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
        <span class="n">nlp</span> <span class="o">=</span> <span class="n">NLPSingleton</span><span class="p">()</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="o">.</span><span class="n">lemmatize</span><span class="p">(</span><span class="n">term</span><span class="p">[</span><span class="s2">"term"</span><span class="p">],</span><span class="s1">'it'</span><span class="p">)</span>
        <span class="n">term</span><span class="p">[</span><span class="s2">"lemma"</span><span class="p">]</span> <span class="o">=</span> <span class="n">term</span><span class="p">[</span><span class="s2">"term"</span><span class="p">]</span>
        <span class="n">head</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">dep_</span> <span class="o">==</span> <span class="s2">"ROOT"</span><span class="p">:</span>
                <span class="n">head</span><span class="p">[</span><span class="s2">"text"</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">text</span>
                <span class="n">head</span><span class="p">[</span><span class="s2">"lemma"</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">lemma_</span>
                <span class="c1">#head["gen"] = token.morph.get("Gender")[0] if len(token.morph.get("Gender")) else ""</span>
                <span class="c1">#head["num"] = token.morph.get("Number")[0] if len(token.morph.get("Number")) else ""</span>

        <span class="c1"># if the lemma of the head matches or there is a frequency of 1, use it as it is</span>
        <span class="k">if</span> <span class="n">head</span><span class="p">[</span><span class="s2">"lemma"</span><span class="p">]</span> <span class="o">==</span> <span class="n">head</span><span class="p">[</span><span class="s2">"text"</span><span class="p">]</span> <span class="ow">or</span> <span class="n">term</span><span class="p">[</span><span class="s2">"frequency"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">term</span>

        <span class="n">lemmas</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">lemma_</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">]</span>

        <span class="n">words</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">"(?: )|(?='[^ ]+)"</span><span class="p">,</span> <span class="n">term</span><span class="p">[</span><span class="s2">"term"</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">words</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">word</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"'"</span><span class="p">):</span>
                <span class="n">words</span><span class="p">[</span><span class="n">indx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">"'"</span>
                <span class="n">words</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># Counting term occurrences</span>
        <span class="n">curr_word_indx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">term_variants</span> <span class="o">=</span> <span class="p">[[]]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">"variants"</span> <span class="ow">in</span> <span class="n">term</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">][</span><span class="s2">"text"</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">sentence</span><span class="p">[</span><span class="s2">"words"</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">curr_word_indx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">lemmas</span><span class="p">):</span>
                        <span class="n">term_variants</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                        <span class="n">curr_word_indx</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">word</span><span class="p">[</span><span class="s2">"lemma"</span><span class="p">]</span> <span class="o">==</span> <span class="n">lemmas</span><span class="p">[</span><span class="n">curr_word_indx</span><span class="p">]:</span>
                        <span class="n">term_variants</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">[</span><span class="s2">"word"</span><span class="p">])</span>
                        <span class="n">curr_word_indx</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">curr_word_indx</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">word</span><span class="p">[</span><span class="s2">"lemma"</span><span class="p">]</span> <span class="o">!=</span> <span class="n">lemmas</span><span class="p">[</span><span class="n">curr_word_indx</span><span class="p">]:</span>
                        <span class="n">term_variants</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">curr_word_indx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">term_variants</span> <span class="o">=</span> <span class="p">[</span><span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">occurence</span><span class="p">)</span> <span class="k">for</span> <span class="n">occurence</span> <span class="ow">in</span> <span class="n">term_variants</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">occurence</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">term_variants</span> <span class="o">=</span> <span class="n">term</span><span class="p">[</span><span class="s2">"variants"</span><span class="p">]</span>

        <span class="c1"># TODO probably a wrong lemmatization and mismatch between spacy and ItaliaNLP</span>
        <span class="c1"># Keep the lemma as the term</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">term_variants</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">term</span>

        <span class="c1"># If i have a verb as single lemma and all it's variants are identified as VERB </span>
        <span class="c1"># (minimize risk of context errors of spacy like "accusa" in a text like "l'accusa decise di" that becomes "accusare")</span>
        <span class="c1"># TODO but may still happen in case of few occurrences</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lemmas</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">doc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pos_</span> <span class="o">==</span> <span class="s2">"VERB"</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">term_variants</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">is_verb</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">variant</span> <span class="ow">in</span> <span class="n">term_variants</span><span class="p">:</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="o">.</span><span class="n">lemmatize</span><span class="p">(</span><span class="n">variant</span><span class="p">,</span><span class="s1">'it'</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">doc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pos_</span> <span class="o">!=</span> <span class="s2">"VERB"</span><span class="p">:</span>
                    <span class="n">is_verb</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">is_verb</span><span class="p">:</span>
                <span class="n">term</span><span class="p">[</span><span class="s2">"lemma"</span><span class="p">]</span> <span class="o">=</span> <span class="n">lemmas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">term</span>            

        <span class="c1"># Taking the most recurrent version and the lemmatized version if tie</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">term_variants</span><span class="p">)</span><span class="o">.</span><span class="n">most_common</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">lemmas</span><span class="p">)</span>
        <span class="n">targetLemma</span> <span class="o">=</span> <span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">counts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Look for all the occurrences, if it's present an occurence equal to the lemmatized version, take that</span>
        <span class="k">for</span> <span class="n">curr_lemma</span><span class="p">,</span> <span class="n">curr_occurrences</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">curr_lemma</span> <span class="o">==</span> <span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lemmas</span><span class="p">):</span>
                <span class="n">term</span><span class="p">[</span><span class="s2">"lemma"</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_lemma</span>
                <span class="k">return</span> <span class="n">term</span>


        <span class="n">term</span><span class="p">[</span><span class="s2">"lemma"</span><span class="p">]</span> <span class="o">=</span> <span class="n">targetLemma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">term</span>

    <span class="k">def</span> <span class="nf">lemmatize_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">terms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">][</span><span class="s2">"terms"</span><span class="p">]</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_language</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s2">"en"</span><span class="p">:</span>
            <span class="n">sem_text</span> <span class="o">=</span> <span class="n">SemanticText</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span> <span class="n">language</span><span class="o">=</span><span class="n">lang</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sem_text</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="n">term</span><span class="p">[</span><span class="s2">"term"</span><span class="p">])</span><span class="o">.</span><span class="n">lemmatize</span><span class="p">())</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">" ’"</span><span class="p">,</span><span class="s2">"’"</span><span class="p">)</span> <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For every term check if the </span>
            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">:</span>
                <span class="n">term</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lemmatize_an_italian_term</span><span class="p">(</span><span class="n">term</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">term</span><span class="p">[</span><span class="s2">"lemma"</span><span class="p">]</span> <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">]</span>

<span class="c1">####################################</span>


    <span class="k">def</span> <span class="nf">get_extracted_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">format</span><span class="p">:</span><span class="n">Literal</span><span class="p">[</span><span class="s1">'str'</span><span class="p">,</span><span class="s1">'list'</span><span class="p">,</span><span class="s1">'list[text,box]'</span><span class="p">,</span><span class="s1">'set[times]'</span><span class="p">,</span><span class="s1">'list[text,time,box]'</span><span class="p">,</span><span class="s1">'list[time,list[text,box]]'</span><span class="p">,</span><span class="s1">'list[id,text,box]'</span><span class="p">]</span><span class="o">=</span><span class="s1">'list'</span><span class="p">):</span> 
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Returns the text extracted from the video.\n</span>
<span class="sd">        Text can be cleaned from non-alphanumeric characters or not.</span>

<span class="sd">        Parameters :</span>
<span class="sd">        ------------</span>
<span class="sd">        - format (str): The desired format of the output. Defaults to 'list[text_id, timed-tuple]'.</span>
<span class="sd">            - 'str': single string with the text joined together.\n</span>
<span class="sd">            - 'list': list of VideoSlides\n</span>
<span class="sd">            - 'set[times] : list of unique texts' times (in seconds) (used for creation of thumbnails)</span>
<span class="sd">            - 'list[time,list[text,box]]': a list of (times, list of (sentence, bounding-box))</span>
<span class="sd">            - 'list[text,box]': list of texts with bounding boxes</span>
<span class="sd">            - 'list[id,text,box]': list of tuple of id, text, and bounding boxes</span>
<span class="sd">            - 'list[text,time,box]': list of repeated times (in seconds) for every text_bounding_boxed</span>
<span class="sd">            - 'list[tuple(id,timed-text)]': list of tuples made of (startend times in seconds, text as string present in those frames)</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_in_video</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">format</span><span class="o">==</span><span class="s1">'list'</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_in_video</span>
        <span class="k">elif</span> <span class="nb">format</span><span class="o">==</span><span class="s1">'str'</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">tft</span><span class="o">.</span><span class="n">get_full_text</span><span class="p">()</span> <span class="k">for</span> <span class="n">tft</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_in_video</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">format</span><span class="o">==</span><span class="s1">'set[times]'</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">video</span> <span class="o">=</span> <span class="n">LocalVideo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tft</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_in_video</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">video</span><span class="o">.</span><span class="n">get_time_from_num_frame</span><span class="p">(</span><span class="n">st_en_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">video</span><span class="o">.</span><span class="n">get_time_from_num_frame</span><span class="p">(</span><span class="n">st_en_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">st_en_frames</span> <span class="ow">in</span> <span class="n">tft</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="k">elif</span> <span class="nb">format</span><span class="o">==</span><span class="s1">'list[text,box]'</span><span class="p">:</span>
            <span class="n">out_lst</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tft</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_in_video</span><span class="p">:</span>
                <span class="n">out_lst</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tft</span><span class="o">.</span><span class="n">get_framed_sentences</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">out_lst</span>
        <span class="k">elif</span> <span class="nb">format</span><span class="o">==</span><span class="s1">'list[id,text,box]'</span><span class="p">:</span>
            <span class="n">timed_text_with_bb</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">tft</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_in_video</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sentence</span><span class="p">,</span><span class="n">bb</span> <span class="ow">in</span> <span class="n">tft</span><span class="o">.</span><span class="n">get_framed_sentences</span><span class="p">():</span>
                    <span class="n">timed_text_with_bb</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">_id</span><span class="p">,</span><span class="n">sentence</span><span class="p">,</span><span class="n">bb</span><span class="p">))</span>
                    <span class="n">_id</span> <span class="o">+=</span><span class="mi">1</span>
            <span class="k">return</span> <span class="n">timed_text_with_bb</span>
        <span class="k">elif</span> <span class="nb">format</span><span class="o">==</span><span class="s1">'list[text,time,box]'</span><span class="p">:</span>
            <span class="n">timed_text_with_bb</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">video</span> <span class="o">=</span> <span class="n">LocalVideo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tft</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_in_video</span><span class="p">:</span>
                <span class="n">st_en_frames</span> <span class="o">=</span> <span class="n">tft</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">sentence</span><span class="p">,</span><span class="n">bb</span> <span class="ow">in</span> <span class="n">tft</span><span class="o">.</span><span class="n">get_framed_sentences</span><span class="p">():</span>
                    <span class="n">timed_text_with_bb</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sentence</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">),(</span><span class="n">video</span><span class="o">.</span><span class="n">get_time_from_num_frame</span><span class="p">(</span><span class="n">st_en_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">video</span><span class="o">.</span><span class="n">get_time_from_num_frame</span><span class="p">(</span><span class="n">st_en_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span><span class="n">bb</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">timed_text_with_bb</span>
        <span class="k">elif</span> <span class="nb">format</span><span class="o">==</span><span class="s1">'list[time,list[text,box]]'</span><span class="p">:</span>
            <span class="n">video</span> <span class="o">=</span> <span class="n">LocalVideo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">)</span>
            <span class="n">timed_text</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">texts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_in_video</span>
            <span class="k">for</span> <span class="n">tft</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">startend</span> <span class="ow">in</span> <span class="n">tft</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">:</span>
                    <span class="n">insort_left</span><span class="p">(</span><span class="n">timed_text</span><span class="p">,((</span><span class="n">video</span><span class="o">.</span><span class="n">get_time_from_num_frame</span><span class="p">(</span><span class="n">startend</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">video</span><span class="o">.</span><span class="n">get_time_from_num_frame</span><span class="p">(</span><span class="n">startend</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="n">tft</span><span class="o">.</span><span class="n">get_full_text</span><span class="p">()))</span>
            <span class="k">return</span> <span class="n">timed_text</span>
        <span class="k">elif</span> <span class="nb">format</span><span class="o">==</span><span class="s1">'list[tuple(id,timed-text)]'</span><span class="p">:</span>
            <span class="n">video</span> <span class="o">=</span> <span class="n">LocalVideo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[(</span><span class="nb">id</span><span class="p">,(</span><span class="n">video</span><span class="o">.</span><span class="n">get_time_from_num_frame</span><span class="p">(</span><span class="n">startend</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">video</span><span class="o">.</span><span class="n">get_time_from_num_frame</span><span class="p">(</span><span class="n">startend</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="n">tft</span><span class="o">.</span><span class="n">get_full_text</span><span class="p">())</span> 
                            <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">tft</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_text_in_video</span><span class="p">)</span> 
                            <span class="k">for</span> <span class="n">startend</span> <span class="ow">in</span> <span class="n">tft</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">]</span>


    <span class="k">def</span> <span class="nf">is_slide_video</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">slide_frames_percent_threshold</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">_show_info</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">'''</span>
<span class="sd">        Computes a threshold against a value that can be calculated or passed as precomputed_value</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        value and slide frames if return value is True\n</span>
<span class="sd">        else\n</span>
<span class="sd">        True and slide frames if percentage of recognized slidish frames is above the threshold</span>
<span class="sd">        '''</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">"slides_percentage"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"video_data"</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"video_data"</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_video</span><span class="p">(</span><span class="n">vsm</span><span class="o">=</span><span class="n">VideoSpeedManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">,</span><span class="n">COLOR_RGB</span><span class="p">),</span><span class="n">_show_info</span><span class="o">=</span><span class="n">_show_info</span><span class="p">)</span>
            <span class="n">mongo</span><span class="o">.</span><span class="n">insert_video_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"video_data"</span><span class="p">][</span><span class="s1">'slides_percentage'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">slide_frames_percent_threshold</span>


    <span class="k">def</span> <span class="nf">extract_slides_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">quant</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">.8</span><span class="p">,</span><span class="n">axis_for_outliers_detection</span><span class="p">:</span><span class="n">Literal</span><span class="p">[</span><span class="s1">'w'</span><span class="p">,</span><span class="s1">'h'</span><span class="p">,</span><span class="s1">'wh'</span><span class="p">]</span><span class="o">=</span><span class="s1">'h'</span><span class="p">,</span><span class="n">union</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">with_times</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Titles are extracted by performing statistics on the axis defined, computing a threshold based on quantiles\n</span>
<span class="sd">        and merging results based on union of results or intersection\n</span>
<span class="sd">        #TODO improvements: now the analysis is performed on the whole list of sentences, but can be performed:\n</span>
<span class="sd">            - per slide\n</span>
<span class="sd">            - then overall\n</span>
<span class="sd">        but i don't know if can be beneficial, depends on style of presentation. </span>
<span class="sd">        For now the assumption is that there's uniform text across all the slides and titles are generally bigger than the other text</span>

<span class="sd">        Then titles are further more filtered by choosing that text whose size is above the threshold, only if it's</span>
<span class="sd">        the first sentence of the slide\n</span>

<span class="sd">        Prerequisites :</span>
<span class="sd">        ------------</span>
<span class="sd">        Must have runned analyze_video()ffmpeg -i /home/gaggio/Documents/Research/ekeel/EVA_apps/EKEELVideoAnnotation/static/videos/lskmIRldsyU/lskmIRldsyU.mp4 -o /home/gaggio/Documents/Research/ekeel/EVA_apps/EKEELVideoAnnotation/static/videos/lskmIRldsyU/lskmIRldsyU.wav</span>

<span class="sd">        Parameters :</span>
<span class="sd">        ----------</span>
<span class="sd">        - quant : quantile as lower bound for outlier detection</span>
<span class="sd">        - axis_for_outliers_detection : axis considered for analysis are 'width' or 'height' or both </span>
<span class="sd">        - union : lastly it's perfomed a union of results (logical OR) or an intersection (logical AND)</span>
<span class="sd">        - with_times : if with_times returns a list of tuples(startend_frames, text, bounding_box)</span>
<span class="sd">                otherwise startend_frames are omitted</span>

<span class="sd">        Returns :</span>
<span class="sd">        ---------</span>
<span class="sd">        List of all the detected titles</span>
<span class="sd">        """</span>
        <span class="k">assert</span> <span class="n">axis_for_outliers_detection</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">'w'</span><span class="p">,</span><span class="s1">'h'</span><span class="p">,</span><span class="s1">'wh'</span><span class="p">}</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">quant</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_extracted_text</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">'list[text,time,box]'</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="c1"># convert input into columns slice for analysis</span>
        <span class="n">sliced_columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'w'</span><span class="p">:</span><span class="nb">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s1">'h'</span><span class="p">:</span><span class="nb">slice</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="s1">'wh'</span><span class="p">:</span><span class="nb">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)}[</span><span class="n">axis_for_outliers_detection</span><span class="p">]</span>
        <span class="n">texts_with_bb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_extracted_text</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">'list[text,time,box]'</span><span class="p">)</span>

        <span class="c1"># select columns</span>
        <span class="n">axis_array</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">text_with_bb</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">sliced_columns</span><span class="p">]</span> <span class="k">for</span> <span class="n">text_with_bb</span> <span class="ow">in</span> <span class="n">texts_with_bb</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">'float'</span><span class="p">,</span><span class="s1">'float'</span><span class="p">))</span>

        <span class="c1"># compute statistical analysis on columns</span>
        <span class="n">indices_above_threshold</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">where</span><span class="p">((</span><span class="n">axis_array</span> <span class="o">&gt;</span> <span class="n">quantile</span><span class="p">(</span><span class="n">axis_array</span><span class="p">,</span><span class="n">quant</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">union</span> <span class="k">else</span> \
                                  <span class="nb">list</span><span class="p">(</span><span class="n">where</span><span class="p">((</span><span class="n">axis_array</span> <span class="o">&gt;</span> <span class="n">quantile</span><span class="p">(</span><span class="n">axis_array</span><span class="p">,</span><span class="n">quant</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">slides_group</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># group by slide</span>
        <span class="c1"># x[0] is one element of indices_above_threshold to compare, x[1] is another</span>
        <span class="c1"># [1] accesses the startend seconds of that VideoSlide  [text, startend, bounding_boxes]</span>
        <span class="c1"># [0] picks the start second of that object [start_second, end_second]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">indices_above_threshold</span><span class="p">),</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">texts_with_bb</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">texts_with_bb</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">slides_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">g</span><span class="p">)))))</span>
        <span class="n">slides_group</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">slides_group</span><span class="p">))</span>

        <span class="c1"># remove indices of text that are classified as titles but are just big text that's not at the top of every slide</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">slides_group</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">indx_text</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">indx_text</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">indx_text</span><span class="o">-</span><span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group</span> <span class="ow">and</span> <span class="p">(</span>                        <span class="c1"># if i'm not at the first index and the text of the previous index is not in the group</span>
                   <span class="n">texts_with_bb</span><span class="p">[</span><span class="n">indx_text</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">texts_with_bb</span><span class="p">[</span><span class="n">indx_text</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span>  <span class="c1"># and the text is in the same slide</span>
                   <span class="n">texts_with_bb</span><span class="p">[</span><span class="n">indx_text</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">texts_with_bb</span><span class="p">[</span><span class="n">indx_text</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>     <span class="c1"># and has a y value lower than my current text (there's another sentence before this one)</span>
                    <span class="n">indices_above_threshold</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">indx_text</span><span class="p">)</span>

        <span class="c1"># selects the texts from the list of texts</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices_above_threshold</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">with_times</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices_above_threshold</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">itemgetter</span><span class="p">(</span><span class="o">*</span><span class="n">indices_above_threshold</span><span class="p">)(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">texts_with_bb</span><span class="p">))[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="mi">2</span><span class="p">])))</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">itemgetter</span><span class="p">(</span><span class="o">*</span><span class="n">indices_above_threshold</span><span class="p">)(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">texts_with_bb</span><span class="p">))[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="mi">2</span><span class="p">])))]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices_above_threshold</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">itemgetter</span><span class="p">(</span><span class="o">*</span><span class="n">indices_above_threshold</span><span class="p">)(</span><span class="n">texts_with_bb</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">itemgetter</span><span class="p">(</span><span class="o">*</span><span class="n">indices_above_threshold</span><span class="p">)(</span><span class="n">texts_with_bb</span><span class="p">)]</span>


    <span class="k">def</span> <span class="nf">create_thumbnails</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">'''</span>
<span class="sd">        Create thumbnails of keyframes from slide segmentation</span>
<span class="sd">        '''</span>

        <span class="c1">#times = self._slide_startends</span>
        <span class="c1">#if times is None:</span>
        <span class="c1">#    times = sorted(self.get_extracted_text(format='set[times]'))</span>
        <span class="c1">#else:</span>
        <span class="c1">#    times = sorted(times)</span>

        <span class="n">images_path</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">VIDEOS_PATH</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">)</span> <span class="c1">#os.path.dirname(os.path.abspath(__file__))</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">File</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".jpg"</span><span class="p">)</span> <span class="k">for</span> <span class="n">File</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".jpg"</span><span class="p">):</span>
                    <span class="n">images_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"videos/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">images_path</span> <span class="o">=</span> <span class="n">images_path</span>
            <span class="k">return</span>

        <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"video_data"</span><span class="p">][</span><span class="s2">"segments"</span><span class="p">]</span>
        <span class="n">video</span> <span class="o">=</span> <span class="n">LocalVideo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">start_seconds</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
            <span class="n">video</span><span class="o">.</span><span class="n">set_num_frame</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get_num_frame_from_time</span><span class="p">(</span><span class="n">start_seconds</span><span class="o">+</span><span class="mf">0.5</span><span class="p">))</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">extract_next_frame</span><span class="p">()</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">".jpg"</span>
            <span class="n">image_file_dir</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">image_file_dir</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(),</span> <span class="n">image</span><span class="p">)</span>
            <span class="n">images_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"videos/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.jpg"</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">images_path</span> <span class="o">=</span> <span class="n">images_path</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">seconds_to_h_mm_ss_dddddd</span><span class="p">(</span><span class="n">time</span><span class="p">:</span><span class="nb">float</span><span class="p">):</span>
        <span class="n">millisec</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">%</span><span class="mi">1</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">millisec</span> <span class="o">+=</span> <span class="s1">'0'</span><span class="o">*</span><span class="p">(</span><span class="mi">6</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">millisec</span><span class="p">))</span>
        <span class="n">seconds</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">)</span><span class="o">%</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">seconds</span> <span class="o">=</span> <span class="s1">'0'</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">seconds</span><span class="p">))</span> <span class="o">+</span> <span class="n">seconds</span>
        <span class="n">minutes</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">/</span><span class="mi">60</span><span class="p">))</span>
        <span class="n">minutes</span> <span class="o">=</span> <span class="s1">'0'</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">minutes</span><span class="p">))</span> <span class="o">+</span> <span class="n">minutes</span>
        <span class="n">hours</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">/</span><span class="mi">3600</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">hours</span><span class="o">+</span><span class="s1">':'</span><span class="o">+</span><span class="n">minutes</span><span class="o">+</span><span class="s1">':'</span><span class="o">+</span><span class="n">seconds</span><span class="o">+</span><span class="s1">'.'</span><span class="o">+</span><span class="n">millisec</span>


    <span class="k">def</span> <span class="nf">adjust_or_insert_definitions_and_indepth_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">burst_concepts</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span><span class="n">definition_tol_seconds</span><span class="p">:</span><span class="nb">float</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span><span class="n">_show_output</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">'''</span>
<span class="sd">        This is an attempt to find definitions from timed sentences of the transcript and the timed titles of the slides.\n</span>
<span class="sd">        Heuristic is that if there's a keyword in the title of a slide (frontpage slide excluded)</span>
<span class="sd">        find the first occurence of that keyword in the transcript within a tolerance seconds window before and after the appearance of the slide</span>
<span class="sd">        set that as "definition" only if it contains the keyword of the title .\n </span>
<span class="sd">        Heuristic for the in-depth is that after definition there's an in-depth of the slide, this means that the concept is explained further there, until the slide with that title won't disappear.\n</span>

<span class="sd">        On the algorithmic side sentences of the transcript used by the heuristic are mapped to the conll version of the text,</span>
<span class="sd">        cleaning operation is performed to remove errors (it groups the contiguous hit of every used sentence of the transcript to the conll by groups len and picks the biggest)\n</span>
<span class="sd">        Then the mapped sentences are aggregated by start and end sentence ids\n</span>
<span class="sd">        Lastly if the burst analysis has different definition times it is overwritten, if it does not contain the definition, this is appended at the end</span>
<span class="sd">        '''</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slide_titles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">'slide titles not set'</span><span class="p">)</span>


        <span class="c1"># extract definitions and in-depths in the transcript of every title based on slide show time and concept citation (especially with definition)</span>
        <span class="n">timed_sentences</span> <span class="o">=</span> <span class="n">get_timed_sentences</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_transcript</span><span class="p">()[</span><span class="mi">0</span><span class="p">],[</span><span class="n">sent</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"text"</span><span class="p">]</span> <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">parse</span><span class="p">(</span><span class="n">get_text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">,</span><span class="n">return_conll</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">])])</span>

        <span class="n">video_defs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">video_in_depths</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">is_introductory_slide</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">title</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slide_titles</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_introductory_slide</span> <span class="ow">or</span> <span class="n">title</span><span class="p">[</span><span class="s1">'start_end_seconds'</span><span class="p">]</span> <span class="o">==</span> <span class="n">start_end_times_introductory_slides</span><span class="p">:</span> <span class="c1"># TODO is there always an introductory slide?</span>
                <span class="n">start_end_times_introductory_slides</span> <span class="o">=</span> <span class="n">title</span><span class="p">[</span><span class="s1">'start_end_seconds'</span><span class="p">]</span>
                <span class="n">is_introductory_slide</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start_time_title</span><span class="p">,</span><span class="n">end_time_title</span> <span class="o">=</span> <span class="n">title</span><span class="p">[</span><span class="s1">'start_end_seconds'</span><span class="p">]</span>
                <span class="n">title_lowered</span> <span class="o">=</span> <span class="n">title</span><span class="p">[</span><span class="s2">"text"</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">title_keyword</span> <span class="o">=</span> <span class="p">[</span><span class="n">burst_concept</span><span class="p">[</span><span class="s1">'concept'</span><span class="p">]</span> <span class="k">for</span> <span class="n">burst_concept</span> <span class="ow">in</span> <span class="n">burst_concepts</span> <span class="k">if</span> <span class="n">burst_concept</span><span class="p">[</span><span class="s1">'concept'</span><span class="p">]</span> <span class="ow">in</span> <span class="n">title_lowered</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">title_keyword</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">title_keyword</span> <span class="o">=</span> <span class="n">title_keyword</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">title_keyword</span> <span class="o">=</span> <span class="n">SemanticText</span><span class="p">(</span><span class="n">title</span><span class="p">[</span><span class="s1">'text'</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'language'</span><span class="p">])</span><span class="o">.</span><span class="n">extract_keywords_from_title</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">sent_id</span><span class="p">,</span> <span class="n">timed_sentence</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">timed_sentences</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">title_keyword</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">video_defs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> \
                       <span class="nb">abs</span><span class="p">(</span><span class="n">start_time_title</span> <span class="o">-</span> <span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'start'</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">definition_tol_seconds</span> <span class="ow">and</span> \
                       <span class="n">title_keyword</span> <span class="ow">in</span> <span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">_show_output</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">()</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">'********** Here comes the definition of the following keyword *******'</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'keyword from title: </span><span class="si">{</span><span class="n">title_keyword</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"time: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'start'</span><span class="p">])[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'end'</span><span class="p">])[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">  |  sentence: </span><span class="si">{</span><span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">()</span>
                        <span class="c1">#timed_sentence['id'] = ts_id</span>
                        <span class="n">video_defs</span><span class="p">[</span><span class="n">title_keyword</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">sent_id</span><span class="p">,</span><span class="n">timed_sentence</span><span class="p">)]</span>

                    <span class="c1"># enlarge end time threshold to incorporate split slides with the same title</span>
                    <span class="k">if</span> <span class="n">title_keyword</span> <span class="ow">in</span> <span class="n">video_defs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> \
                       <span class="n">end_time_title</span> <span class="o">&gt;</span> <span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'end'</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> \
                       <span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'start'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">video_defs</span><span class="p">[</span><span class="n">title_keyword</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s1">'start'</span><span class="p">]:</span> <span class="c1"># and \</span>
                       <span class="c1">#txt_classif.is_partially_in_txt_version(title_keywords[0],timed_sentence['text']):</span>
                        <span class="k">if</span> <span class="n">title_keyword</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">video_in_depths</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">_show_output</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">'********** Here comes the indepth of the following keyword *******'</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'keyword from title: </span><span class="si">{</span><span class="n">title_keyword</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"time: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'start'</span><span class="p">])[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'end'</span><span class="p">])[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">  |  sentence: </span><span class="si">{</span><span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                            <span class="c1">#timed_sentence['id'] = ts_id</span>
                            <span class="n">video_in_depths</span><span class="p">[</span><span class="n">title_keyword</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">sent_id</span><span class="p">,</span><span class="n">timed_sentence</span><span class="p">)]</span>

                        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="kc">True</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">tmd_sentence</span> <span class="ow">in</span> <span class="n">video_in_depths</span><span class="p">[</span><span class="n">title_keyword</span><span class="p">]</span> <span class="k">if</span> <span class="n">tmd_sentence</span><span class="p">[</span><span class="s1">'start'</span><span class="p">]</span> <span class="o">==</span> <span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'start'</span><span class="p">]]):</span>
                            <span class="c1">#timed_sentence['id'] = ts_id</span>
                            <span class="n">video_in_depths</span><span class="p">[</span><span class="n">title_keyword</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sent_id</span><span class="p">,</span><span class="n">timed_sentence</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">_show_output</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"time: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'start'</span><span class="p">])[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'end'</span><span class="p">])[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">  |  sentence: </span><span class="si">{</span><span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Creating or modifying burst_concept definition of the video results </span>
        <span class="n">added_concepts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">concepts_used</span> <span class="o">=</span> <span class="p">{</span><span class="n">concept</span><span class="p">:</span><span class="kc">False</span> <span class="k">for</span> <span class="n">concept</span> <span class="ow">in</span> <span class="n">video_defs</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="n">concept_description_type</span> <span class="o">=</span> <span class="s2">"Definition"</span>
        <span class="k">for</span> <span class="n">burst_concept</span> <span class="ow">in</span> <span class="n">burst_concepts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">burst_concept</span><span class="p">[</span><span class="s2">"concept"</span><span class="p">]</span> <span class="ow">in</span> <span class="n">video_defs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">burst_concept</span><span class="p">[</span><span class="s2">"description_type"</span><span class="p">]</span> <span class="o">==</span> <span class="n">concept_description_type</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">burst_concept</span><span class="p">[</span><span class="s2">"start_sent_id"</span><span class="p">]</span> <span class="o">!=</span> <span class="n">video_defs</span><span class="p">[</span><span class="n">burst_concept</span><span class="p">[</span><span class="s2">"concept"</span><span class="p">]][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> \
                   <span class="n">burst_concept</span><span class="p">[</span><span class="s2">"end_sent_id"</span><span class="p">]</span> <span class="o">!=</span> <span class="n">video_defs</span><span class="p">[</span><span class="n">burst_concept</span><span class="p">[</span><span class="s2">"concept"</span><span class="p">]][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">burst_concept_name</span> <span class="o">=</span> <span class="n">burst_concept</span><span class="p">[</span><span class="s1">'concept'</span><span class="p">]</span>
                    <span class="n">burst_concept</span><span class="p">[</span><span class="s1">'start_sent_id'</span><span class="p">]</span> <span class="o">=</span> <span class="n">video_defs</span><span class="p">[</span><span class="n">burst_concept_name</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">burst_concept</span><span class="p">[</span><span class="s1">'end_sent_id'</span><span class="p">]</span> <span class="o">=</span> <span class="n">video_defs</span><span class="p">[</span><span class="n">burst_concept_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">burst_concept</span><span class="p">[</span><span class="s1">'start'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seconds_to_h_mm_ss_dddddd</span><span class="p">(</span><span class="n">video_defs</span><span class="p">[</span><span class="n">burst_concept_name</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">"start"</span><span class="p">])</span>
                    <span class="n">burst_concept</span><span class="p">[</span><span class="s1">'end'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seconds_to_h_mm_ss_dddddd</span><span class="p">(</span><span class="n">video_defs</span><span class="p">[</span><span class="n">burst_concept_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">"end"</span><span class="p">])</span>
                    <span class="n">burst_concept</span><span class="p">[</span><span class="s1">'creator'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Video_Analysis"</span>
                    <span class="n">concepts_used</span><span class="p">[</span><span class="n">burst_concept_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">concept_name</span> <span class="ow">in</span> <span class="n">video_defs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">concepts_used</span><span class="p">[</span><span class="n">concept_name</span><span class="p">]:</span>
                <span class="n">burst_concepts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span> <span class="s1">'concept'</span><span class="p">:</span><span class="n">concept_name</span><span class="p">,</span>
                                        <span class="s1">'start_sent_id'</span><span class="p">:</span><span class="n">video_defs</span><span class="p">[</span><span class="n">concept_name</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                        <span class="s1">'end_sent_id'</span><span class="p">:</span><span class="n">video_defs</span><span class="p">[</span><span class="n">concept_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                        <span class="s1">'start'</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">seconds_to_h_mm_ss_dddddd</span><span class="p">(</span><span class="n">video_defs</span><span class="p">[</span><span class="n">concept_name</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s1">'start'</span><span class="p">]),</span>
                                        <span class="s1">'end'</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">seconds_to_h_mm_ss_dddddd</span><span class="p">(</span><span class="n">video_defs</span><span class="p">[</span><span class="n">concept_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">"end"</span><span class="p">]),</span>
                                        <span class="s1">'description_type'</span><span class="p">:</span><span class="n">concept_description_type</span><span class="p">,</span>
                                        <span class="s1">'creator'</span><span class="p">:</span><span class="s1">'Video_Analysis'</span><span class="p">})</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">concept_name</span> <span class="ow">in</span> <span class="n">added_concepts</span><span class="p">:</span>
                    <span class="n">added_concepts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concept_name</span><span class="p">)</span>

        <span class="c1"># In Depths must be managed differently since there can be more than one</span>
        <span class="n">concepts_used</span> <span class="o">=</span> <span class="p">{</span><span class="n">concept</span><span class="p">:</span><span class="kc">False</span> <span class="k">for</span> <span class="n">concept</span> <span class="ow">in</span> <span class="n">video_in_depths</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="n">concept_description_type</span> <span class="o">=</span> <span class="s2">"In Depth"</span>
        <span class="k">for</span> <span class="n">video_concept_name</span> <span class="ow">in</span> <span class="n">video_in_depths</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">most_proximal</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'found'</span><span class="p">:</span><span class="kc">False</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">burst_concept</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">burst_concepts</span><span class="p">))):</span>

                <span class="k">if</span> <span class="n">burst_concept</span><span class="p">[</span><span class="s2">"concept"</span><span class="p">]</span> <span class="o">==</span> <span class="n">video_concept_name</span> <span class="ow">and</span> <span class="n">burst_concept</span><span class="p">[</span><span class="s2">"description_type"</span><span class="p">]</span> <span class="o">==</span> <span class="n">concept_description_type</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">most_proximal</span><span class="p">[</span><span class="s2">"found"</span><span class="p">]:</span>
                        <span class="n">most_proximal</span><span class="p">[</span><span class="s1">'found'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">most_proximal</span><span class="p">[</span><span class="s2">"id"</span><span class="p">]</span> <span class="o">=</span> <span class="n">id_</span>
                        <span class="n">most_proximal</span><span class="p">[</span><span class="s1">'diff_start_sent_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">burst_concept</span><span class="p">[</span><span class="s1">'start_sent_id'</span><span class="p">]</span><span class="o">-</span><span class="n">video_in_depths</span><span class="p">[</span><span class="n">video_concept_name</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">most_proximal</span><span class="p">[</span><span class="s1">'diff_end_sent_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">burst_concept</span><span class="p">[</span><span class="s1">'end_sent_id'</span><span class="p">]</span><span class="o">-</span><span class="n">video_in_depths</span><span class="p">[</span><span class="n">video_concept_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">most_proximal</span><span class="p">[</span><span class="s1">'diff_start_sent_id'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">burst_concept</span><span class="p">[</span><span class="s1">'start_sent_id'</span><span class="p">]</span><span class="o">-</span><span class="n">video_in_depths</span><span class="p">[</span><span class="n">video_concept_name</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>
                            <span class="n">most_proximal</span><span class="p">[</span><span class="s2">"id"</span><span class="p">]</span> <span class="o">=</span> <span class="n">id_</span>
                            <span class="n">most_proximal</span><span class="p">[</span><span class="s1">'diff_start_sent_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">burst_concept</span><span class="p">[</span><span class="s1">'start_sent_id'</span><span class="p">]</span><span class="o">-</span><span class="n">video_in_depths</span><span class="p">[</span><span class="n">video_concept_name</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">most_proximal</span><span class="p">[</span><span class="s1">'diff_end_sent_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">burst_concept</span><span class="p">[</span><span class="s1">'end_sent_id'</span><span class="p">]</span><span class="o">-</span><span class="n">video_in_depths</span><span class="p">[</span><span class="n">video_concept_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

                <span class="k">elif</span> <span class="n">most_proximal</span><span class="p">[</span><span class="s1">'found'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">burst_concept</span><span class="p">[</span><span class="s2">"concept"</span><span class="p">]</span> <span class="o">!=</span> <span class="n">video_concept_name</span><span class="p">:</span>
                    <span class="n">target_concept</span> <span class="o">=</span> <span class="n">burst_concepts</span><span class="p">[</span><span class="n">most_proximal</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]]</span>
                    <span class="n">target_concept</span><span class="p">[</span><span class="s1">'start'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seconds_to_h_mm_ss_dddddd</span><span class="p">(</span><span class="n">video_in_depths</span><span class="p">[</span><span class="n">video_concept_name</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">"start"</span><span class="p">])</span>
                    <span class="n">target_concept</span><span class="p">[</span><span class="s1">'end'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seconds_to_h_mm_ss_dddddd</span><span class="p">(</span><span class="n">video_in_depths</span><span class="p">[</span><span class="n">video_concept_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">"end"</span><span class="p">])</span>
                    <span class="n">target_concept</span><span class="p">[</span><span class="s1">'start_sent_id'</span><span class="p">]</span> <span class="o">=</span> <span class="n">video_in_depths</span><span class="p">[</span><span class="n">video_concept_name</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">target_concept</span><span class="p">[</span><span class="s1">'end_sent_id'</span><span class="p">]</span> <span class="o">=</span> <span class="n">video_in_depths</span><span class="p">[</span><span class="n">video_concept_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">target_concept</span><span class="p">[</span><span class="s1">'creator'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'Video_Analysis'</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">most_proximal</span><span class="p">[</span><span class="s1">'found'</span><span class="p">]:</span>
                <span class="n">burst_concepts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span> <span class="s1">'concept'</span><span class="p">:</span><span class="n">video_concept_name</span><span class="p">,</span>
                                        <span class="s1">'start_sent_id'</span><span class="p">:</span><span class="n">video_in_depths</span><span class="p">[</span><span class="n">video_concept_name</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                        <span class="s1">'end_sent_id'</span><span class="p">:</span><span class="n">video_in_depths</span><span class="p">[</span><span class="n">video_concept_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                        <span class="s1">'start'</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">seconds_to_h_mm_ss_dddddd</span><span class="p">(</span><span class="n">video_in_depths</span><span class="p">[</span><span class="n">video_concept_name</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s1">'start'</span><span class="p">]),</span>
                                        <span class="s1">'end'</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">seconds_to_h_mm_ss_dddddd</span><span class="p">(</span><span class="n">video_in_depths</span><span class="p">[</span><span class="n">video_concept_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">"end"</span><span class="p">]),</span>
                                        <span class="s1">'description_type'</span><span class="p">:</span><span class="n">concept_description_type</span><span class="p">,</span>
                                        <span class="s1">'creator'</span><span class="p">:</span><span class="s1">'Video_Analysis'</span><span class="p">})</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">concept_name</span> <span class="ow">in</span> <span class="n">added_concepts</span><span class="p">:</span>
                    <span class="n">added_concepts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concept_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">added_concepts</span><span class="p">,</span><span class="n">burst_concepts</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.adjust_or_insert_definitions_and_indepth_times" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">adjust_or_insert_definitions_and_indepth_times</span><span class="p">(</span><span class="n">burst_concepts</span><span class="p">,</span> <span class="n">definition_tol_seconds</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">_show_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>This is an attempt to find definitions from timed sentences of the transcript and the timed titles of the slides.</p>
<p>Heuristic is that if there's a keyword in the title of a slide (frontpage slide excluded)
find the first occurence of that keyword in the transcript within a tolerance seconds window before and after the appearance of the slide
set that as "definition" only if it contains the keyword of the title .</p>
<p>Heuristic for the in-depth is that after definition there's an in-depth of the slide, this means that the concept is explained further there, until the slide with that title won't disappear.</p>
<p>On the algorithmic side sentences of the transcript used by the heuristic are mapped to the conll version of the text,
cleaning operation is performed to remove errors (it groups the contiguous hit of every used sentence of the transcript to the conll by groups len and picks the biggest)</p>
<p>Then the mapped sentences are aggregated by start and end sentence ids</p>
<p>Lastly if the burst analysis has different definition times it is overwritten, if it does not contain the definition, this is appended at the end</p>

            <details class="quote">
              <summary>Source code in <code>EVA_apps/EKEELVideoAnnotation/media/segmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">adjust_or_insert_definitions_and_indepth_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">burst_concepts</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span><span class="n">definition_tol_seconds</span><span class="p">:</span><span class="nb">float</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span><span class="n">_show_output</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">'''</span>
<span class="sd">    This is an attempt to find definitions from timed sentences of the transcript and the timed titles of the slides.\n</span>
<span class="sd">    Heuristic is that if there's a keyword in the title of a slide (frontpage slide excluded)</span>
<span class="sd">    find the first occurence of that keyword in the transcript within a tolerance seconds window before and after the appearance of the slide</span>
<span class="sd">    set that as "definition" only if it contains the keyword of the title .\n </span>
<span class="sd">    Heuristic for the in-depth is that after definition there's an in-depth of the slide, this means that the concept is explained further there, until the slide with that title won't disappear.\n</span>

<span class="sd">    On the algorithmic side sentences of the transcript used by the heuristic are mapped to the conll version of the text,</span>
<span class="sd">    cleaning operation is performed to remove errors (it groups the contiguous hit of every used sentence of the transcript to the conll by groups len and picks the biggest)\n</span>
<span class="sd">    Then the mapped sentences are aggregated by start and end sentence ids\n</span>
<span class="sd">    Lastly if the burst analysis has different definition times it is overwritten, if it does not contain the definition, this is appended at the end</span>
<span class="sd">    '''</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slide_titles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">'slide titles not set'</span><span class="p">)</span>


    <span class="c1"># extract definitions and in-depths in the transcript of every title based on slide show time and concept citation (especially with definition)</span>
    <span class="n">timed_sentences</span> <span class="o">=</span> <span class="n">get_timed_sentences</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_transcript</span><span class="p">()[</span><span class="mi">0</span><span class="p">],[</span><span class="n">sent</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"text"</span><span class="p">]</span> <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">parse</span><span class="p">(</span><span class="n">get_text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">,</span><span class="n">return_conll</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">])])</span>

    <span class="n">video_defs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">video_in_depths</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">is_introductory_slide</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">title</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slide_titles</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_introductory_slide</span> <span class="ow">or</span> <span class="n">title</span><span class="p">[</span><span class="s1">'start_end_seconds'</span><span class="p">]</span> <span class="o">==</span> <span class="n">start_end_times_introductory_slides</span><span class="p">:</span> <span class="c1"># TODO is there always an introductory slide?</span>
            <span class="n">start_end_times_introductory_slides</span> <span class="o">=</span> <span class="n">title</span><span class="p">[</span><span class="s1">'start_end_seconds'</span><span class="p">]</span>
            <span class="n">is_introductory_slide</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start_time_title</span><span class="p">,</span><span class="n">end_time_title</span> <span class="o">=</span> <span class="n">title</span><span class="p">[</span><span class="s1">'start_end_seconds'</span><span class="p">]</span>
            <span class="n">title_lowered</span> <span class="o">=</span> <span class="n">title</span><span class="p">[</span><span class="s2">"text"</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">title_keyword</span> <span class="o">=</span> <span class="p">[</span><span class="n">burst_concept</span><span class="p">[</span><span class="s1">'concept'</span><span class="p">]</span> <span class="k">for</span> <span class="n">burst_concept</span> <span class="ow">in</span> <span class="n">burst_concepts</span> <span class="k">if</span> <span class="n">burst_concept</span><span class="p">[</span><span class="s1">'concept'</span><span class="p">]</span> <span class="ow">in</span> <span class="n">title_lowered</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">title_keyword</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">title_keyword</span> <span class="o">=</span> <span class="n">title_keyword</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">title_keyword</span> <span class="o">=</span> <span class="n">SemanticText</span><span class="p">(</span><span class="n">title</span><span class="p">[</span><span class="s1">'text'</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'language'</span><span class="p">])</span><span class="o">.</span><span class="n">extract_keywords_from_title</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">sent_id</span><span class="p">,</span> <span class="n">timed_sentence</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">timed_sentences</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">title_keyword</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">video_defs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> \
                   <span class="nb">abs</span><span class="p">(</span><span class="n">start_time_title</span> <span class="o">-</span> <span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'start'</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">definition_tol_seconds</span> <span class="ow">and</span> \
                   <span class="n">title_keyword</span> <span class="ow">in</span> <span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">_show_output</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">()</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">'********** Here comes the definition of the following keyword *******'</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'keyword from title: </span><span class="si">{</span><span class="n">title_keyword</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"time: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'start'</span><span class="p">])[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'end'</span><span class="p">])[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">  |  sentence: </span><span class="si">{</span><span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">()</span>
                    <span class="c1">#timed_sentence['id'] = ts_id</span>
                    <span class="n">video_defs</span><span class="p">[</span><span class="n">title_keyword</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">sent_id</span><span class="p">,</span><span class="n">timed_sentence</span><span class="p">)]</span>

                <span class="c1"># enlarge end time threshold to incorporate split slides with the same title</span>
                <span class="k">if</span> <span class="n">title_keyword</span> <span class="ow">in</span> <span class="n">video_defs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> \
                   <span class="n">end_time_title</span> <span class="o">&gt;</span> <span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'end'</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> \
                   <span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'start'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">video_defs</span><span class="p">[</span><span class="n">title_keyword</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s1">'start'</span><span class="p">]:</span> <span class="c1"># and \</span>
                   <span class="c1">#txt_classif.is_partially_in_txt_version(title_keywords[0],timed_sentence['text']):</span>
                    <span class="k">if</span> <span class="n">title_keyword</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">video_in_depths</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">_show_output</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">'********** Here comes the indepth of the following keyword *******'</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'keyword from title: </span><span class="si">{</span><span class="n">title_keyword</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"time: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'start'</span><span class="p">])[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'end'</span><span class="p">])[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">  |  sentence: </span><span class="si">{</span><span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                        <span class="c1">#timed_sentence['id'] = ts_id</span>
                        <span class="n">video_in_depths</span><span class="p">[</span><span class="n">title_keyword</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">sent_id</span><span class="p">,</span><span class="n">timed_sentence</span><span class="p">)]</span>

                    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="kc">True</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">tmd_sentence</span> <span class="ow">in</span> <span class="n">video_in_depths</span><span class="p">[</span><span class="n">title_keyword</span><span class="p">]</span> <span class="k">if</span> <span class="n">tmd_sentence</span><span class="p">[</span><span class="s1">'start'</span><span class="p">]</span> <span class="o">==</span> <span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'start'</span><span class="p">]]):</span>
                        <span class="c1">#timed_sentence['id'] = ts_id</span>
                        <span class="n">video_in_depths</span><span class="p">[</span><span class="n">title_keyword</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sent_id</span><span class="p">,</span><span class="n">timed_sentence</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">_show_output</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"time: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'start'</span><span class="p">])[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'end'</span><span class="p">])[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">  |  sentence: </span><span class="si">{</span><span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Creating or modifying burst_concept definition of the video results </span>
    <span class="n">added_concepts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">concepts_used</span> <span class="o">=</span> <span class="p">{</span><span class="n">concept</span><span class="p">:</span><span class="kc">False</span> <span class="k">for</span> <span class="n">concept</span> <span class="ow">in</span> <span class="n">video_defs</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="n">concept_description_type</span> <span class="o">=</span> <span class="s2">"Definition"</span>
    <span class="k">for</span> <span class="n">burst_concept</span> <span class="ow">in</span> <span class="n">burst_concepts</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">burst_concept</span><span class="p">[</span><span class="s2">"concept"</span><span class="p">]</span> <span class="ow">in</span> <span class="n">video_defs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">burst_concept</span><span class="p">[</span><span class="s2">"description_type"</span><span class="p">]</span> <span class="o">==</span> <span class="n">concept_description_type</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">burst_concept</span><span class="p">[</span><span class="s2">"start_sent_id"</span><span class="p">]</span> <span class="o">!=</span> <span class="n">video_defs</span><span class="p">[</span><span class="n">burst_concept</span><span class="p">[</span><span class="s2">"concept"</span><span class="p">]][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> \
               <span class="n">burst_concept</span><span class="p">[</span><span class="s2">"end_sent_id"</span><span class="p">]</span> <span class="o">!=</span> <span class="n">video_defs</span><span class="p">[</span><span class="n">burst_concept</span><span class="p">[</span><span class="s2">"concept"</span><span class="p">]][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">burst_concept_name</span> <span class="o">=</span> <span class="n">burst_concept</span><span class="p">[</span><span class="s1">'concept'</span><span class="p">]</span>
                <span class="n">burst_concept</span><span class="p">[</span><span class="s1">'start_sent_id'</span><span class="p">]</span> <span class="o">=</span> <span class="n">video_defs</span><span class="p">[</span><span class="n">burst_concept_name</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">burst_concept</span><span class="p">[</span><span class="s1">'end_sent_id'</span><span class="p">]</span> <span class="o">=</span> <span class="n">video_defs</span><span class="p">[</span><span class="n">burst_concept_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">burst_concept</span><span class="p">[</span><span class="s1">'start'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seconds_to_h_mm_ss_dddddd</span><span class="p">(</span><span class="n">video_defs</span><span class="p">[</span><span class="n">burst_concept_name</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">"start"</span><span class="p">])</span>
                <span class="n">burst_concept</span><span class="p">[</span><span class="s1">'end'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seconds_to_h_mm_ss_dddddd</span><span class="p">(</span><span class="n">video_defs</span><span class="p">[</span><span class="n">burst_concept_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">"end"</span><span class="p">])</span>
                <span class="n">burst_concept</span><span class="p">[</span><span class="s1">'creator'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Video_Analysis"</span>
                <span class="n">concepts_used</span><span class="p">[</span><span class="n">burst_concept_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">for</span> <span class="n">concept_name</span> <span class="ow">in</span> <span class="n">video_defs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">concepts_used</span><span class="p">[</span><span class="n">concept_name</span><span class="p">]:</span>
            <span class="n">burst_concepts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span> <span class="s1">'concept'</span><span class="p">:</span><span class="n">concept_name</span><span class="p">,</span>
                                    <span class="s1">'start_sent_id'</span><span class="p">:</span><span class="n">video_defs</span><span class="p">[</span><span class="n">concept_name</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="s1">'end_sent_id'</span><span class="p">:</span><span class="n">video_defs</span><span class="p">[</span><span class="n">concept_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="s1">'start'</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">seconds_to_h_mm_ss_dddddd</span><span class="p">(</span><span class="n">video_defs</span><span class="p">[</span><span class="n">concept_name</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s1">'start'</span><span class="p">]),</span>
                                    <span class="s1">'end'</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">seconds_to_h_mm_ss_dddddd</span><span class="p">(</span><span class="n">video_defs</span><span class="p">[</span><span class="n">concept_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">"end"</span><span class="p">]),</span>
                                    <span class="s1">'description_type'</span><span class="p">:</span><span class="n">concept_description_type</span><span class="p">,</span>
                                    <span class="s1">'creator'</span><span class="p">:</span><span class="s1">'Video_Analysis'</span><span class="p">})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">concept_name</span> <span class="ow">in</span> <span class="n">added_concepts</span><span class="p">:</span>
                <span class="n">added_concepts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concept_name</span><span class="p">)</span>

    <span class="c1"># In Depths must be managed differently since there can be more than one</span>
    <span class="n">concepts_used</span> <span class="o">=</span> <span class="p">{</span><span class="n">concept</span><span class="p">:</span><span class="kc">False</span> <span class="k">for</span> <span class="n">concept</span> <span class="ow">in</span> <span class="n">video_in_depths</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="n">concept_description_type</span> <span class="o">=</span> <span class="s2">"In Depth"</span>
    <span class="k">for</span> <span class="n">video_concept_name</span> <span class="ow">in</span> <span class="n">video_in_depths</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">most_proximal</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'found'</span><span class="p">:</span><span class="kc">False</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">burst_concept</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">burst_concepts</span><span class="p">))):</span>

            <span class="k">if</span> <span class="n">burst_concept</span><span class="p">[</span><span class="s2">"concept"</span><span class="p">]</span> <span class="o">==</span> <span class="n">video_concept_name</span> <span class="ow">and</span> <span class="n">burst_concept</span><span class="p">[</span><span class="s2">"description_type"</span><span class="p">]</span> <span class="o">==</span> <span class="n">concept_description_type</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">most_proximal</span><span class="p">[</span><span class="s2">"found"</span><span class="p">]:</span>
                    <span class="n">most_proximal</span><span class="p">[</span><span class="s1">'found'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">most_proximal</span><span class="p">[</span><span class="s2">"id"</span><span class="p">]</span> <span class="o">=</span> <span class="n">id_</span>
                    <span class="n">most_proximal</span><span class="p">[</span><span class="s1">'diff_start_sent_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">burst_concept</span><span class="p">[</span><span class="s1">'start_sent_id'</span><span class="p">]</span><span class="o">-</span><span class="n">video_in_depths</span><span class="p">[</span><span class="n">video_concept_name</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">most_proximal</span><span class="p">[</span><span class="s1">'diff_end_sent_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">burst_concept</span><span class="p">[</span><span class="s1">'end_sent_id'</span><span class="p">]</span><span class="o">-</span><span class="n">video_in_depths</span><span class="p">[</span><span class="n">video_concept_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">most_proximal</span><span class="p">[</span><span class="s1">'diff_start_sent_id'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">burst_concept</span><span class="p">[</span><span class="s1">'start_sent_id'</span><span class="p">]</span><span class="o">-</span><span class="n">video_in_depths</span><span class="p">[</span><span class="n">video_concept_name</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="n">most_proximal</span><span class="p">[</span><span class="s2">"id"</span><span class="p">]</span> <span class="o">=</span> <span class="n">id_</span>
                        <span class="n">most_proximal</span><span class="p">[</span><span class="s1">'diff_start_sent_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">burst_concept</span><span class="p">[</span><span class="s1">'start_sent_id'</span><span class="p">]</span><span class="o">-</span><span class="n">video_in_depths</span><span class="p">[</span><span class="n">video_concept_name</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">most_proximal</span><span class="p">[</span><span class="s1">'diff_end_sent_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">burst_concept</span><span class="p">[</span><span class="s1">'end_sent_id'</span><span class="p">]</span><span class="o">-</span><span class="n">video_in_depths</span><span class="p">[</span><span class="n">video_concept_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">elif</span> <span class="n">most_proximal</span><span class="p">[</span><span class="s1">'found'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">burst_concept</span><span class="p">[</span><span class="s2">"concept"</span><span class="p">]</span> <span class="o">!=</span> <span class="n">video_concept_name</span><span class="p">:</span>
                <span class="n">target_concept</span> <span class="o">=</span> <span class="n">burst_concepts</span><span class="p">[</span><span class="n">most_proximal</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]]</span>
                <span class="n">target_concept</span><span class="p">[</span><span class="s1">'start'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seconds_to_h_mm_ss_dddddd</span><span class="p">(</span><span class="n">video_in_depths</span><span class="p">[</span><span class="n">video_concept_name</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">"start"</span><span class="p">])</span>
                <span class="n">target_concept</span><span class="p">[</span><span class="s1">'end'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seconds_to_h_mm_ss_dddddd</span><span class="p">(</span><span class="n">video_in_depths</span><span class="p">[</span><span class="n">video_concept_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">"end"</span><span class="p">])</span>
                <span class="n">target_concept</span><span class="p">[</span><span class="s1">'start_sent_id'</span><span class="p">]</span> <span class="o">=</span> <span class="n">video_in_depths</span><span class="p">[</span><span class="n">video_concept_name</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">target_concept</span><span class="p">[</span><span class="s1">'end_sent_id'</span><span class="p">]</span> <span class="o">=</span> <span class="n">video_in_depths</span><span class="p">[</span><span class="n">video_concept_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">target_concept</span><span class="p">[</span><span class="s1">'creator'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'Video_Analysis'</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">most_proximal</span><span class="p">[</span><span class="s1">'found'</span><span class="p">]:</span>
            <span class="n">burst_concepts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span> <span class="s1">'concept'</span><span class="p">:</span><span class="n">video_concept_name</span><span class="p">,</span>
                                    <span class="s1">'start_sent_id'</span><span class="p">:</span><span class="n">video_in_depths</span><span class="p">[</span><span class="n">video_concept_name</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="s1">'end_sent_id'</span><span class="p">:</span><span class="n">video_in_depths</span><span class="p">[</span><span class="n">video_concept_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="s1">'start'</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">seconds_to_h_mm_ss_dddddd</span><span class="p">(</span><span class="n">video_in_depths</span><span class="p">[</span><span class="n">video_concept_name</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s1">'start'</span><span class="p">]),</span>
                                    <span class="s1">'end'</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">seconds_to_h_mm_ss_dddddd</span><span class="p">(</span><span class="n">video_in_depths</span><span class="p">[</span><span class="n">video_concept_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">"end"</span><span class="p">]),</span>
                                    <span class="s1">'description_type'</span><span class="p">:</span><span class="n">concept_description_type</span><span class="p">,</span>
                                    <span class="s1">'creator'</span><span class="p">:</span><span class="s1">'Video_Analysis'</span><span class="p">})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">concept_name</span> <span class="ow">in</span> <span class="n">added_concepts</span><span class="p">:</span>
                <span class="n">added_concepts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concept_name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">added_concepts</span><span class="p">,</span><span class="n">burst_concepts</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.analyze_video" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analyze_video</span><span class="p">(</span><span class="n">_show_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Analyzes a video to identify and extract slides, transitioning between different states 
(WAITING_OPENING, OPENING, CONTENT, ENDED) based on the content of the video frames.
It's based on the EduOpen format, so it will look for the logo and start looking for the text using a state machine based algorithm</p>
<p>Parameters:
_show_info (bool): Flag to control the display of processing information. Defaults to True.</p>
<p>Returns:
None</p>

            <details class="quote">
              <summary>Source code in <code>EVA_apps/EKEELVideoAnnotation/media/segmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">analyze_video</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">_show_info</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Analyzes a video to identify and extract slides, transitioning between different states </span>
<span class="sd">    (WAITING_OPENING, OPENING, CONTENT, ENDED) based on the content of the video frames.</span>
<span class="sd">    It's based on the EduOpen format, so it will look for the logo and start looking for the text using a state machine based algorithm</span>

<span class="sd">    Parameters:</span>
<span class="sd">    _show_info (bool): Flag to control the display of processing information. Defaults to True.</span>

<span class="sd">    Returns:</span>
<span class="sd">    None</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_slide_video</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">"slides"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"video_data"</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">return</span>

    <span class="k">class</span> <span class="nc">State</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
        <span class="n">WAITING_OPENING</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
        <span class="n">OPENING</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
        <span class="n">CONTENT</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
        <span class="n">ENDED</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>


    <span class="n">video</span> <span class="o">=</span> <span class="n">SimpleVideo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">)</span>
    <span class="n">video</span><span class="o">.</span><span class="n">set_step</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get_fps</span><span class="p">())</span>

    <span class="n">slides</span><span class="p">:</span><span class="nb">list</span><span class="p">[</span><span class="n">VideoSlide</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># We start looking for EduOpen</span>
    <span class="c1"># Then transit to content</span>
    <span class="c1"># Ending is optional (sometimes videos are cut)</span>
    <span class="n">state_machine</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"state"</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">State</span><span class="p">)[</span><span class="mi">0</span><span class="p">]}</span>
    <span class="n">next_state</span> <span class="o">=</span> <span class="p">{</span> <span class="n">from_state</span><span class="p">:</span><span class="n">to_state</span> <span class="k">for</span> <span class="n">from_state</span><span class="p">,</span> <span class="n">to_state</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">State</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">State</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="kc">None</span><span class="p">]))</span> <span class="p">}</span>
    <span class="n">prev_frame</span> <span class="o">=</span> <span class="n">ImageClassifier</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get_frame</span><span class="p">())</span>
    <span class="n">curr_frame</span> <span class="o">=</span> <span class="n">prev_frame</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">speed_up_coef</span> <span class="o">=</span> <span class="mf">0.35</span>
    <span class="n">fps</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">get_fps</span><span class="p">()</span>
    <span class="n">max_speed</span> <span class="o">=</span> <span class="n">fps</span> <span class="o">*</span> <span class="mi">10</span>
    <span class="n">curr_slide</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>

        <span class="c1"># We have finished</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">curr_frame</span><span class="o">.</span><span class="n">has_image</span><span class="p">():</span>
            <span class="n">state_machine</span><span class="p">[</span><span class="s2">"state"</span><span class="p">]</span> <span class="o">=</span> <span class="n">State</span><span class="o">.</span><span class="n">ENDED</span>

        <span class="n">curr_state</span> <span class="o">=</span> <span class="n">state_machine</span><span class="p">[</span><span class="s1">'state'</span><span class="p">]</span>

        <span class="c1"># We are looking for the edu (o) pen word (the o is not recognized)</span>
        <span class="k">if</span> <span class="n">curr_state</span> <span class="o">==</span> <span class="n">State</span><span class="o">.</span><span class="n">WAITING_OPENING</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">curr_frame</span><span class="o">.</span><span class="n">is_same_image</span><span class="p">(</span><span class="n">prev_frame</span><span class="p">):</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">curr_frame</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span><span class="n">return_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">"edu"</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="s2">"pen"</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                    <span class="n">state_machine</span><span class="p">[</span><span class="s2">"state"</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_state</span><span class="p">[</span><span class="n">curr_state</span><span class="p">]</span>
                    <span class="n">video</span><span class="o">.</span><span class="n">set_step</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get_fps</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">video</span><span class="o">.</span><span class="n">set_step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">_curr_step</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">video</span><span class="o">.</span><span class="n">get_fps</span><span class="p">()</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>

        <span class="c1"># We are looking in a change in the text that won't have edu and open in the text</span>
        <span class="k">elif</span> <span class="n">curr_state</span> <span class="o">==</span> <span class="n">State</span><span class="o">.</span><span class="n">OPENING</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">curr_frame</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span><span class="n">return_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s2">"edu"</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">or</span> <span class="ow">not</span> <span class="s2">"pen"</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="p">:</span>
                <span class="n">state_machine</span><span class="p">[</span><span class="s1">'state'</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_state</span><span class="p">[</span><span class="n">curr_state</span><span class="p">]</span>

        <span class="c1"># We start processing slides reading the text at increasing video speed (capped at max speed) </span>
        <span class="c1"># as we find same text in the image</span>
        <span class="k">elif</span> <span class="n">curr_state</span> <span class="o">==</span> <span class="n">State</span><span class="o">.</span><span class="n">CONTENT</span><span class="p">:</span>
            <span class="n">texts_with_bb</span> <span class="o">=</span> <span class="n">curr_frame</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span><span class="n">return_text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_contours</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Found text</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">texts_with_bb</span><span class="p">):</span>

                <span class="c1"># Create new slide</span>
                <span class="k">if</span> <span class="n">curr_slide</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">curr_slide</span> <span class="o">=</span> <span class="n">VideoSlide</span><span class="p">(</span><span class="n">texts_with_bb</span><span class="p">,</span> <span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get_frame_index</span><span class="p">(),</span> <span class="kc">None</span><span class="p">))</span>

                <span class="c1"># Check if it's the same slide as the one cached</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_slide</span> <span class="o">=</span> <span class="n">VideoSlide</span><span class="p">(</span><span class="n">texts_with_bb</span><span class="p">,</span> <span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get_frame_index</span><span class="p">(),</span><span class="kc">None</span><span class="p">))</span>

                    <span class="c1"># If different append the previous slide setting it's end and reset the playback speed</span>
                    <span class="k">if</span> <span class="n">new_slide</span> <span class="o">!=</span> <span class="n">curr_slide</span><span class="p">:</span>
                        <span class="n">curr_slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">curr_slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">video</span><span class="o">.</span><span class="n">get_frame_index</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
                        <span class="n">slides</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_slide</span><span class="p">)</span>
                        <span class="n">curr_slide</span> <span class="o">=</span> <span class="n">new_slide</span>
                        <span class="n">video</span><span class="o">.</span><span class="n">set_step</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get_fps</span><span class="p">()</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>

                    <span class="c1"># If same slide increase playback speed</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">video</span><span class="o">.</span><span class="n">set_step</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">_curr_step</span> <span class="o">+</span> <span class="n">speed_up_coef</span> <span class="o">*</span> <span class="n">max_speed</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_speed</span><span class="p">)))</span>

            <span class="c1"># Not found text</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># If there is a slide save it, set it's end and reset playback speed</span>
                <span class="k">if</span> <span class="n">curr_slide</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">curr_slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">curr_slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">video</span><span class="o">.</span><span class="n">get_frame_index</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
                    <span class="n">slides</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_slide</span><span class="p">)</span>
                    <span class="n">curr_slide</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">video</span><span class="o">.</span><span class="n">set_step</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get_fps</span><span class="p">()</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># If the last slide has not an end_frame because the video ended before, we assign last frame</span>
        <span class="k">elif</span> <span class="n">curr_state</span> <span class="o">==</span> <span class="n">State</span><span class="o">.</span><span class="n">ENDED</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">curr_slide</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">slides</span><span class="p">)</span> <span class="ow">and</span> <span class="n">curr_slide</span> <span class="o">!=</span> <span class="n">slides</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">curr_slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">curr_slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">video</span><span class="o">.</span><span class="n">get_frame_index</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
                <span class="n">slides</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_slide</span><span class="p">)</span>
            <span class="k">break</span>   

        <span class="n">prev_frame</span><span class="o">.</span><span class="n">set_img</span><span class="p">(</span><span class="n">curr_frame</span><span class="o">.</span><span class="n">get_img</span><span class="p">())</span>
        <span class="n">curr_frame</span><span class="o">.</span><span class="n">set_img</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get_frame</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">_show_info</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Doing </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">video</span><span class="o">.</span><span class="n">_curr_frame_idx</span><span class="o">-</span><span class="n">video</span><span class="o">.</span><span class="n">_curr_step</span><span class="p">)</span><span class="o">/</span><span class="n">video</span><span class="o">.</span><span class="n">get_count_frames</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">%  curr step </span><span class="si">{</span><span class="n">video</span><span class="o">.</span><span class="n">_curr_step</span><span class="si">}</span><span class="s2"> num slides </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">slides</span><span class="p">)</span><span class="si">}</span><span class="s2">    "</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s2">"</span><span class="se">\r</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Cleaning doubles</span>
    <span class="c1"># TODO need to implement method to remove gibberish</span>
    <span class="n">txt_classif</span> <span class="o">=</span> <span class="n">TextSimilarityClassifier</span><span class="p">(</span><span class="n">comp_methods</span><span class="o">=</span><span class="p">{</span><span class="n">ComparisonMethods</span><span class="o">.</span><span class="n">FUZZY_PARTIAL_RATIO</span><span class="p">,</span> <span class="n">ComparisonMethods</span><span class="o">.</span><span class="n">CHARS_COMMON_DISTRIB</span><span class="p">})</span>
    <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">n_iter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">changed</span><span class="p">:</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">to_reverse</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">slide1</span><span class="p">,</span><span class="n">slide2</span> <span class="ow">in</span> <span class="n">pairwise</span><span class="p">(</span><span class="n">slides</span><span class="p">,</span> <span class="n">None_tail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">reversed</span><span class="o">=</span><span class="n">to_reverse</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">txt_classif</span><span class="o">.</span><span class="n">is_partially_in</span><span class="p">(</span><span class="n">slide1</span><span class="p">,</span><span class="n">slide2</span><span class="p">):</span>
                    <span class="n">slide2</span><span class="p">:</span><span class="n">VideoSlide</span>
                    <span class="n">slide2</span><span class="o">.</span><span class="n">merge_frames</span><span class="p">(</span><span class="n">slide1</span><span class="p">)</span>
                    <span class="n">slides</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">slide1</span><span class="p">)</span>
                    <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">n_iter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">slide1</span><span class="p">,</span> <span class="n">slide2</span> <span class="ow">in</span> <span class="n">double_iterator</span><span class="p">(</span><span class="n">slides</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">txt_classif</span><span class="o">.</span><span class="n">is_partially_in</span><span class="p">(</span><span class="n">slide2</span><span class="p">,</span><span class="n">slide1</span><span class="p">):</span>
                <span class="n">slide1</span><span class="p">:</span><span class="n">VideoSlide</span>
                <span class="n">slide1</span><span class="o">.</span><span class="n">merge_frames</span><span class="p">(</span><span class="n">slide2</span><span class="p">)</span>
                <span class="n">slides</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">slide2</span><span class="p">)</span>
                <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">n_iter</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Now correct slides offsets to the first and last frame they appear</span>
    <span class="c1"># TODO need to implement binary search because it's too slow</span>
    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">fps</span><span class="o">//</span><span class="mi">5</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">)</span> <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">slides</span><span class="p">])</span>
        <span class="n">iter_</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">slides</span><span class="p">:</span>
            <span class="n">this_slide_text</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">_full_text</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">start_frame</span><span class="p">,</span> <span class="n">end_frame</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">):</span>

                <span class="c1"># Shifting start frame backward</span>
                <span class="n">video</span><span class="o">.</span><span class="n">rewind</span><span class="p">()</span>
                <span class="n">video</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">start_frame</span><span class="p">)</span>
                <span class="n">video</span><span class="o">.</span><span class="n">set_step</span><span class="p">(</span><span class="o">-</span><span class="n">step</span><span class="p">)</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">other_frame_text</span> <span class="o">=</span> <span class="n">curr_frame</span><span class="o">.</span><span class="n">set_img</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get_frame</span><span class="p">())</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span><span class="n">return_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start_frame</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> \
                       <span class="p">(</span><span class="n">this_slide_text</span> <span class="o">!=</span> <span class="n">other_frame_text</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">slide</span><span class="o">.</span><span class="n">txt_sim_class</span><span class="o">.</span><span class="n">are_cosine_similar</span><span class="p">(</span><span class="n">this_slide_text</span><span class="p">,</span> <span class="n">other_frame_text</span><span class="p">,</span><span class="n">confidence</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)):</span>
                        <span class="n">start_frame</span> <span class="o">+=</span> <span class="n">step</span>
                        <span class="k">break</span>

                    <span class="n">start_frame</span> <span class="o">-=</span> <span class="n">step</span>

                <span class="c1"># Shifting end frame forward</span>
                <span class="n">video</span><span class="o">.</span><span class="n">rewind</span><span class="p">()</span>
                <span class="n">video</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">end_frame</span><span class="p">)</span>
                <span class="n">video</span><span class="o">.</span><span class="n">set_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">other_frame_text</span> <span class="o">=</span> <span class="n">curr_frame</span><span class="o">.</span><span class="n">set_img</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get_frame</span><span class="p">())</span><span class="o">.</span><span class="n">extract_text</span><span class="p">(</span><span class="n">return_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">)</span> <span class="ow">and</span> <span class="n">slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">end_frame</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> \
                       <span class="p">(</span><span class="n">this_slide_text</span> <span class="o">!=</span> <span class="n">other_frame_text</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">slide</span><span class="o">.</span><span class="n">txt_sim_class</span><span class="o">.</span><span class="n">are_cosine_similar</span><span class="p">(</span><span class="n">this_slide_text</span><span class="p">,</span> <span class="n">other_frame_text</span><span class="p">,</span><span class="n">confidence</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)):</span>
                        <span class="n">end_frame</span> <span class="o">-=</span> <span class="n">step</span>
                        <span class="k">break</span>

                    <span class="n">end_frame</span> <span class="o">+=</span> <span class="n">step</span>

                <span class="n">iter_</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"At </span><span class="si">{</span><span class="n">iter_</span><span class="o">/</span><span class="n">total</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">%"</span><span class="p">)</span>
                <span class="c1"># We reassign the frames</span>
                <span class="n">slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_frame</span><span class="p">,</span> <span class="n">end_frame</span><span class="p">)</span>

    <span class="c1"># Convert into seconds</span>
    <span class="k">for</span> <span class="n">slide</span> <span class="ow">in</span> <span class="n">slides</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">start_frame</span><span class="p">,</span> <span class="n">end_frame</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">):</span>
            <span class="n">slide</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_frame</span><span class="o">/</span><span class="n">fps</span><span class="p">,</span> <span class="n">end_frame</span><span class="o">/</span><span class="n">fps</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"video_data"</span><span class="p">][</span><span class="s2">"slides"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">tft</span><span class="p">)</span> <span class="k">for</span> <span class="n">tft</span> <span class="ow">in</span> <span class="n">slides</span><span class="p">]</span>

    <span class="n">mongo</span><span class="o">.</span><span class="n">insert_video_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.create_thumbnails" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_thumbnails</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create thumbnails of keyframes from slide segmentation</p>

            <details class="quote">
              <summary>Source code in <code>EVA_apps/EKEELVideoAnnotation/media/segmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_thumbnails</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">'''</span>
<span class="sd">    Create thumbnails of keyframes from slide segmentation</span>
<span class="sd">    '''</span>

    <span class="c1">#times = self._slide_startends</span>
    <span class="c1">#if times is None:</span>
    <span class="c1">#    times = sorted(self.get_extracted_text(format='set[times]'))</span>
    <span class="c1">#else:</span>
    <span class="c1">#    times = sorted(times)</span>

    <span class="n">images_path</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">VIDEOS_PATH</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">)</span> <span class="c1">#os.path.dirname(os.path.abspath(__file__))</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">File</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".jpg"</span><span class="p">)</span> <span class="k">for</span> <span class="n">File</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".jpg"</span><span class="p">):</span>
                <span class="n">images_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"videos/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">images_path</span> <span class="o">=</span> <span class="n">images_path</span>
        <span class="k">return</span>

    <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"video_data"</span><span class="p">][</span><span class="s2">"segments"</span><span class="p">]</span>
    <span class="n">video</span> <span class="o">=</span> <span class="n">LocalVideo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">start_seconds</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
        <span class="n">video</span><span class="o">.</span><span class="n">set_num_frame</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">get_num_frame_from_time</span><span class="p">(</span><span class="n">start_seconds</span><span class="o">+</span><span class="mf">0.5</span><span class="p">))</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">extract_next_frame</span><span class="p">()</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">".jpg"</span>
        <span class="n">image_file_dir</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">image_file_dir</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(),</span> <span class="n">image</span><span class="p">)</span>
        <span class="n">images_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"videos/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.jpg"</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">images_path</span> <span class="o">=</span> <span class="n">images_path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.download_video" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">download_video</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Downloads the video (expected YouTube video)</p>
<p>If the video has been removed from youtube, it attempts to remove the folder from both the drive and the database, then raises an Exception</p>
<hr>
<h4 id="/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.download_video--note">NOTE</h4>
<p>There are problems very often with YouTube, which breaks yt_dlp library.</p>
<p>In case of errors try to update the library</p>

            <details class="quote">
              <summary>Source code in <code>EVA_apps/EKEELVideoAnnotation/media/segmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">download_video</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">'''</span>
<span class="sd">    Downloads the video (expected YouTube video)\n</span>
<span class="sd">    If the video has been removed from youtube, it attempts to remove the folder from both the drive and the database, then raises an Exception\n</span>

<span class="sd">    --------------</span>
<span class="sd">    # NOTE</span>
<span class="sd">    There are problems very often with YouTube, which breaks yt_dlp library.\n </span>
<span class="sd">    In case of errors try to update the library</span>
<span class="sd">    '''</span>
    <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span>
    <span class="c1">#video_link = url.split('&amp;')[0]</span>
    <span class="n">video_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_id</span>
    <span class="n">folder_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder_path</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span><span class="n">video_id</span><span class="o">+</span><span class="s1">'.mp4'</span><span class="p">)):</span>
        <span class="k">return</span>

    <span class="c1"># Both pafy and pytube seems to be not mantained anymore, only youtube_dlp is still alive</span>

    <span class="n">prev_cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1">#print("using ytdl")</span>
        <span class="c1">#yt_dlp.YoutubeDL({'format': 'bestvideo[height&lt;=480]', 'quiet': True}).download([url])</span>
        <span class="n">yt_dlp</span><span class="o">.</span><span class="n">YoutubeDL</span><span class="p">({</span>  <span class="s1">'quiet'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="s1">'format'</span><span class="p">:</span> <span class="s1">'bestvideo[height&lt;=720]+bestaudio/best[height&lt;=720]'</span><span class="p">,</span>
                            <span class="s1">'outtmpl'</span><span class="p">:</span> <span class="n">video_id</span><span class="o">+</span><span class="s1">'.mp4'</span><span class="p">,</span>
                            <span class="s1">'merge_output_format'</span><span class="p">:</span> <span class="s1">'mp4'</span><span class="p">,</span>
                            <span class="s1">'ffmpeg_location'</span><span class="p">:</span> <span class="s1">'/usr/bin/ffmpeg'</span><span class="p">,</span>
                            <span class="s1">'postprocessors'</span><span class="p">:</span> <span class="p">[{</span>
                                <span class="s1">'key'</span><span class="p">:</span> <span class="s1">'FFmpegVideoConvertor'</span><span class="p">,</span>
                                <span class="s1">'preferedformat'</span><span class="p">:</span> <span class="s1">'mp4'</span><span class="p">,</span>  <span class="c1"># Ensure the output is in mp4 format</span>
                                <span class="p">}],</span>
                              <span class="p">})</span><span class="o">.</span><span class="n">download</span><span class="p">([</span><span class="n">url</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">prev_cwd</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".mp4"</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">folder_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">file</span><span class="p">),</span><span class="n">folder_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">video_id</span><span class="o">+</span><span class="s2">"."</span><span class="o">+</span><span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"."</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">vidcap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">folder_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">video_id</span><span class="o">+</span><span class="s2">"."</span><span class="o">+</span><span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"."</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">vidcap</span><span class="o">.</span><span class="n">isOpened</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">min</span><span class="p">((</span><span class="n">vidcap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_WIDTH</span><span class="p">),</span><span class="n">vidcap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_HEIGHT</span><span class="p">)))</span> <span class="o">&gt;=</span> <span class="mi">360</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Video does not have enough definition to find text"</span><span class="p">)</span>
            <span class="k">break</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.extract_slides_title" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">extract_slides_title</span><span class="p">(</span><span class="n">quant</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">axis_for_outliers_detection</span><span class="o">=</span><span class="s1">'h'</span><span class="p">,</span> <span class="n">union</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_times</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Titles are extracted by performing statistics on the axis defined, computing a threshold based on quantiles</p>
<p>and merging results based on union of results or intersection</p>
<h4 id="/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.extract_slides_title--todo-improvements-now-the-analysis-is-performed-on-the-whole-list-of-sentences-but-can-be-performed">TODO improvements: now the analysis is performed on the whole list of sentences, but can be performed:</h4>
<pre><code>- per slide

- then overall
</code></pre>
<p>but i don't know if can be beneficial, depends on style of presentation. 
For now the assumption is that there's uniform text across all the slides and titles are generally bigger than the other text</p>
<p>Then titles are further more filtered by choosing that text whose size is above the threshold, only if it's
the first sentence of the slide</p>


<details class="prerequisites-:" open>
  <summary>Prerequisites :</summary>
  <p>Must have runned analyze_video()ffmpeg -i /home/gaggio/Documents/Research/ekeel/EVA_apps/EKEELVideoAnnotation/static/videos/lskmIRldsyU/lskmIRldsyU.mp4 -o /home/gaggio/Documents/Research/ekeel/EVA_apps/EKEELVideoAnnotation/static/videos/lskmIRldsyU/lskmIRldsyU.wav</p>
</details>

<details class="parameters-:" open>
  <summary>Parameters :</summary>
  <ul>
<li>quant : quantile as lower bound for outlier detection</li>
<li>axis_for_outliers_detection : axis considered for analysis are 'width' or 'height' or both </li>
<li>union : lastly it's perfomed a union of results (logical OR) or an intersection (logical AND)</li>
<li>with_times : if with_times returns a list of tuples(startend_frames, text, bounding_box)
        otherwise startend_frames are omitted</li>
</ul>
</details>

<details class="returns-:" open>
  <summary>Returns :</summary>
  <p>List of all the detected titles</p>
</details>
            <details class="quote">
              <summary>Source code in <code>EVA_apps/EKEELVideoAnnotation/media/segmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">extract_slides_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">quant</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">.8</span><span class="p">,</span><span class="n">axis_for_outliers_detection</span><span class="p">:</span><span class="n">Literal</span><span class="p">[</span><span class="s1">'w'</span><span class="p">,</span><span class="s1">'h'</span><span class="p">,</span><span class="s1">'wh'</span><span class="p">]</span><span class="o">=</span><span class="s1">'h'</span><span class="p">,</span><span class="n">union</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">with_times</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Titles are extracted by performing statistics on the axis defined, computing a threshold based on quantiles\n</span>
<span class="sd">    and merging results based on union of results or intersection\n</span>
<span class="sd">    #TODO improvements: now the analysis is performed on the whole list of sentences, but can be performed:\n</span>
<span class="sd">        - per slide\n</span>
<span class="sd">        - then overall\n</span>
<span class="sd">    but i don't know if can be beneficial, depends on style of presentation. </span>
<span class="sd">    For now the assumption is that there's uniform text across all the slides and titles are generally bigger than the other text</span>

<span class="sd">    Then titles are further more filtered by choosing that text whose size is above the threshold, only if it's</span>
<span class="sd">    the first sentence of the slide\n</span>

<span class="sd">    Prerequisites :</span>
<span class="sd">    ------------</span>
<span class="sd">    Must have runned analyze_video()ffmpeg -i /home/gaggio/Documents/Research/ekeel/EVA_apps/EKEELVideoAnnotation/static/videos/lskmIRldsyU/lskmIRldsyU.mp4 -o /home/gaggio/Documents/Research/ekeel/EVA_apps/EKEELVideoAnnotation/static/videos/lskmIRldsyU/lskmIRldsyU.wav</span>

<span class="sd">    Parameters :</span>
<span class="sd">    ----------</span>
<span class="sd">    - quant : quantile as lower bound for outlier detection</span>
<span class="sd">    - axis_for_outliers_detection : axis considered for analysis are 'width' or 'height' or both </span>
<span class="sd">    - union : lastly it's perfomed a union of results (logical OR) or an intersection (logical AND)</span>
<span class="sd">    - with_times : if with_times returns a list of tuples(startend_frames, text, bounding_box)</span>
<span class="sd">            otherwise startend_frames are omitted</span>

<span class="sd">    Returns :</span>
<span class="sd">    ---------</span>
<span class="sd">    List of all the detected titles</span>
<span class="sd">    """</span>
    <span class="k">assert</span> <span class="n">axis_for_outliers_detection</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">'w'</span><span class="p">,</span><span class="s1">'h'</span><span class="p">,</span><span class="s1">'wh'</span><span class="p">}</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">quant</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_extracted_text</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">'list[text,time,box]'</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="c1"># convert input into columns slice for analysis</span>
    <span class="n">sliced_columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'w'</span><span class="p">:</span><span class="nb">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="s1">'h'</span><span class="p">:</span><span class="nb">slice</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="s1">'wh'</span><span class="p">:</span><span class="nb">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)}[</span><span class="n">axis_for_outliers_detection</span><span class="p">]</span>
    <span class="n">texts_with_bb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_extracted_text</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">'list[text,time,box]'</span><span class="p">)</span>

    <span class="c1"># select columns</span>
    <span class="n">axis_array</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">text_with_bb</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">sliced_columns</span><span class="p">]</span> <span class="k">for</span> <span class="n">text_with_bb</span> <span class="ow">in</span> <span class="n">texts_with_bb</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">(</span><span class="s1">'float'</span><span class="p">,</span><span class="s1">'float'</span><span class="p">))</span>

    <span class="c1"># compute statistical analysis on columns</span>
    <span class="n">indices_above_threshold</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">where</span><span class="p">((</span><span class="n">axis_array</span> <span class="o">&gt;</span> <span class="n">quantile</span><span class="p">(</span><span class="n">axis_array</span><span class="p">,</span><span class="n">quant</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">union</span> <span class="k">else</span> \
                              <span class="nb">list</span><span class="p">(</span><span class="n">where</span><span class="p">((</span><span class="n">axis_array</span> <span class="o">&gt;</span> <span class="n">quantile</span><span class="p">(</span><span class="n">axis_array</span><span class="p">,</span><span class="n">quant</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">slides_group</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># group by slide</span>
    <span class="c1"># x[0] is one element of indices_above_threshold to compare, x[1] is another</span>
    <span class="c1"># [1] accesses the startend seconds of that VideoSlide  [text, startend, bounding_boxes]</span>
    <span class="c1"># [0] picks the start second of that object [start_second, end_second]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">indices_above_threshold</span><span class="p">),</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">texts_with_bb</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">texts_with_bb</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">slides_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">g</span><span class="p">)))))</span>
    <span class="n">slides_group</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">slides_group</span><span class="p">))</span>

    <span class="c1"># remove indices of text that are classified as titles but are just big text that's not at the top of every slide</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">slides_group</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">indx_text</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">indx_text</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">indx_text</span><span class="o">-</span><span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group</span> <span class="ow">and</span> <span class="p">(</span>                        <span class="c1"># if i'm not at the first index and the text of the previous index is not in the group</span>
               <span class="n">texts_with_bb</span><span class="p">[</span><span class="n">indx_text</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">texts_with_bb</span><span class="p">[</span><span class="n">indx_text</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span>  <span class="c1"># and the text is in the same slide</span>
               <span class="n">texts_with_bb</span><span class="p">[</span><span class="n">indx_text</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">texts_with_bb</span><span class="p">[</span><span class="n">indx_text</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>     <span class="c1"># and has a y value lower than my current text (there's another sentence before this one)</span>
                <span class="n">indices_above_threshold</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">indx_text</span><span class="p">)</span>

    <span class="c1"># selects the texts from the list of texts</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices_above_threshold</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">with_times</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices_above_threshold</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">itemgetter</span><span class="p">(</span><span class="o">*</span><span class="n">indices_above_threshold</span><span class="p">)(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">texts_with_bb</span><span class="p">))[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="mi">2</span><span class="p">])))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">itemgetter</span><span class="p">(</span><span class="o">*</span><span class="n">indices_above_threshold</span><span class="p">)(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">texts_with_bb</span><span class="p">))[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="mi">2</span><span class="p">])))]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices_above_threshold</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">itemgetter</span><span class="p">(</span><span class="o">*</span><span class="n">indices_above_threshold</span><span class="p">)(</span><span class="n">texts_with_bb</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">itemgetter</span><span class="p">(</span><span class="o">*</span><span class="n">indices_above_threshold</span><span class="p">)(</span><span class="n">texts_with_bb</span><span class="p">)]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.extract_video_id" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">extract_video_id</span><span class="p">(</span><span class="n">url</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>From a YouTube url extracts the video id</p>

            <details class="quote">
              <summary>Source code in <code>EVA_apps/EKEELVideoAnnotation/media/segmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">extract_video_id</span><span class="p">(</span><span class="n">url</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">'''</span>
<span class="sd">    From a YouTube url extracts the video id</span>
<span class="sd">    '''</span>
    <span class="n">video_link</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'&amp;'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">'='</span> <span class="ow">in</span> <span class="n">video_link</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">video_link</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'='</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">video_link</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.get_extracted_text" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_extracted_text</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">'list'</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Returns the text extracted from the video.</p>
<p>Text can be cleaned from non-alphanumeric characters or not.</p>


<details class="parameters-:" open>
  <summary>Parameters :</summary>
  <ul>
<li>
<p>format (str): The desired format of the output. Defaults to 'list[text_id, timed-tuple]'.</p>
<ul>
<li>
<p>'str': single string with the text joined together.</p>
</li>
<li>
<p>'list': list of VideoSlides</p>
</li>
<li>
<p>'set[times] : list of unique texts' times (in seconds) (used for creation of thumbnails)</p>
</li>
<li>'list[time,list[text,box]]': a list of (times, list of (sentence, bounding-box))</li>
<li>'list[text,box]': list of texts with bounding boxes</li>
<li>'list[id,text,box]': list of tuple of id, text, and bounding boxes</li>
<li>'list[text,time,box]': list of repeated times (in seconds) for every text_bounding_boxed</li>
<li>'list[tuple(id,timed-text)]': list of tuples made of (startend times in seconds, text as string present in those frames)</li>
</ul>
</li>
</ul>
</details>
            <details class="quote">
              <summary>Source code in <code>EVA_apps/EKEELVideoAnnotation/media/segmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_extracted_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">format</span><span class="p">:</span><span class="n">Literal</span><span class="p">[</span><span class="s1">'str'</span><span class="p">,</span><span class="s1">'list'</span><span class="p">,</span><span class="s1">'list[text,box]'</span><span class="p">,</span><span class="s1">'set[times]'</span><span class="p">,</span><span class="s1">'list[text,time,box]'</span><span class="p">,</span><span class="s1">'list[time,list[text,box]]'</span><span class="p">,</span><span class="s1">'list[id,text,box]'</span><span class="p">]</span><span class="o">=</span><span class="s1">'list'</span><span class="p">):</span> 
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Returns the text extracted from the video.\n</span>
<span class="sd">    Text can be cleaned from non-alphanumeric characters or not.</span>

<span class="sd">    Parameters :</span>
<span class="sd">    ------------</span>
<span class="sd">    - format (str): The desired format of the output. Defaults to 'list[text_id, timed-tuple]'.</span>
<span class="sd">        - 'str': single string with the text joined together.\n</span>
<span class="sd">        - 'list': list of VideoSlides\n</span>
<span class="sd">        - 'set[times] : list of unique texts' times (in seconds) (used for creation of thumbnails)</span>
<span class="sd">        - 'list[time,list[text,box]]': a list of (times, list of (sentence, bounding-box))</span>
<span class="sd">        - 'list[text,box]': list of texts with bounding boxes</span>
<span class="sd">        - 'list[id,text,box]': list of tuple of id, text, and bounding boxes</span>
<span class="sd">        - 'list[text,time,box]': list of repeated times (in seconds) for every text_bounding_boxed</span>
<span class="sd">        - 'list[tuple(id,timed-text)]': list of tuples made of (startend times in seconds, text as string present in those frames)</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_in_video</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">format</span><span class="o">==</span><span class="s1">'list'</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_in_video</span>
    <span class="k">elif</span> <span class="nb">format</span><span class="o">==</span><span class="s1">'str'</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">tft</span><span class="o">.</span><span class="n">get_full_text</span><span class="p">()</span> <span class="k">for</span> <span class="n">tft</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_in_video</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">format</span><span class="o">==</span><span class="s1">'set[times]'</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">video</span> <span class="o">=</span> <span class="n">LocalVideo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tft</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_in_video</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">video</span><span class="o">.</span><span class="n">get_time_from_num_frame</span><span class="p">(</span><span class="n">st_en_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">video</span><span class="o">.</span><span class="n">get_time_from_num_frame</span><span class="p">(</span><span class="n">st_en_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">st_en_frames</span> <span class="ow">in</span> <span class="n">tft</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">elif</span> <span class="nb">format</span><span class="o">==</span><span class="s1">'list[text,box]'</span><span class="p">:</span>
        <span class="n">out_lst</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tft</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_in_video</span><span class="p">:</span>
            <span class="n">out_lst</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tft</span><span class="o">.</span><span class="n">get_framed_sentences</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">out_lst</span>
    <span class="k">elif</span> <span class="nb">format</span><span class="o">==</span><span class="s1">'list[id,text,box]'</span><span class="p">:</span>
        <span class="n">timed_text_with_bb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">tft</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_in_video</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sentence</span><span class="p">,</span><span class="n">bb</span> <span class="ow">in</span> <span class="n">tft</span><span class="o">.</span><span class="n">get_framed_sentences</span><span class="p">():</span>
                <span class="n">timed_text_with_bb</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">_id</span><span class="p">,</span><span class="n">sentence</span><span class="p">,</span><span class="n">bb</span><span class="p">))</span>
                <span class="n">_id</span> <span class="o">+=</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">timed_text_with_bb</span>
    <span class="k">elif</span> <span class="nb">format</span><span class="o">==</span><span class="s1">'list[text,time,box]'</span><span class="p">:</span>
        <span class="n">timed_text_with_bb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">video</span> <span class="o">=</span> <span class="n">LocalVideo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tft</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_in_video</span><span class="p">:</span>
            <span class="n">st_en_frames</span> <span class="o">=</span> <span class="n">tft</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">sentence</span><span class="p">,</span><span class="n">bb</span> <span class="ow">in</span> <span class="n">tft</span><span class="o">.</span><span class="n">get_framed_sentences</span><span class="p">():</span>
                <span class="n">timed_text_with_bb</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sentence</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">),(</span><span class="n">video</span><span class="o">.</span><span class="n">get_time_from_num_frame</span><span class="p">(</span><span class="n">st_en_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">video</span><span class="o">.</span><span class="n">get_time_from_num_frame</span><span class="p">(</span><span class="n">st_en_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span><span class="n">bb</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">timed_text_with_bb</span>
    <span class="k">elif</span> <span class="nb">format</span><span class="o">==</span><span class="s1">'list[time,list[text,box]]'</span><span class="p">:</span>
        <span class="n">video</span> <span class="o">=</span> <span class="n">LocalVideo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">)</span>
        <span class="n">timed_text</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">texts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_in_video</span>
        <span class="k">for</span> <span class="n">tft</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">startend</span> <span class="ow">in</span> <span class="n">tft</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">:</span>
                <span class="n">insort_left</span><span class="p">(</span><span class="n">timed_text</span><span class="p">,((</span><span class="n">video</span><span class="o">.</span><span class="n">get_time_from_num_frame</span><span class="p">(</span><span class="n">startend</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">video</span><span class="o">.</span><span class="n">get_time_from_num_frame</span><span class="p">(</span><span class="n">startend</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="n">tft</span><span class="o">.</span><span class="n">get_full_text</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">timed_text</span>
    <span class="k">elif</span> <span class="nb">format</span><span class="o">==</span><span class="s1">'list[tuple(id,timed-text)]'</span><span class="p">:</span>
        <span class="n">video</span> <span class="o">=</span> <span class="n">LocalVideo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[(</span><span class="nb">id</span><span class="p">,(</span><span class="n">video</span><span class="o">.</span><span class="n">get_time_from_num_frame</span><span class="p">(</span><span class="n">startend</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">video</span><span class="o">.</span><span class="n">get_time_from_num_frame</span><span class="p">(</span><span class="n">startend</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="n">tft</span><span class="o">.</span><span class="n">get_full_text</span><span class="p">())</span> 
                        <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">tft</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_text_in_video</span><span class="p">)</span> 
                        <span class="k">for</span> <span class="n">startend</span> <span class="ow">in</span> <span class="n">tft</span><span class="o">.</span><span class="n">start_end_frames</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.identify_language" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">identify_language</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">'pt1'</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Recognizes the video language (currently implemented ita and eng so it raises exception if not one of these)</p>

            <details class="quote">
              <summary>Source code in <code>EVA_apps/EKEELVideoAnnotation/media/segmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">identify_language</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span><span class="n">Literal</span><span class="p">[</span><span class="s1">'full'</span><span class="p">,</span><span class="s1">'pt1'</span><span class="p">]</span><span class="o">=</span><span class="s1">'pt1'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">'''</span>
<span class="sd">    Recognizes the video language (currently implemented ita and eng so it raises exception if not one of these)</span>
<span class="sd">    '''</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="s1">'language'</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'language'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">YTTranscriptApi</span><span class="o">.</span><span class="n">list_transcripts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">)</span><span class="o">.</span><span class="n">_generated_transcripts</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> 

    <span class="n">locale</span> <span class="o">=</span> <span class="n">Locale</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">locale</span><span class="o">.</span><span class="n">is_language_supported</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'language'</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Language is not between supported ones: </span><span class="si">{</span><span class="n">locale</span><span class="o">.</span><span class="n">get_supported_languages</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'language'</span><span class="p">]</span> <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span><span class="s1">'pt1'</span> <span class="k">else</span> <span class="n">locale</span><span class="o">.</span><span class="n">get_full_from_pt1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'language'</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.is_slide_video" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_slide_video</span><span class="p">(</span><span class="n">slide_frames_percent_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">_show_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Computes a threshold against a value that can be calculated or passed as precomputed_value</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>value and slide frames if return value is True</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code>else</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code>True and slide frames if percentage of recognized slidish frames is above the threshold</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>EVA_apps/EKEELVideoAnnotation/media/segmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">is_slide_video</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">slide_frames_percent_threshold</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">_show_info</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">'''</span>
<span class="sd">    Computes a threshold against a value that can be calculated or passed as precomputed_value</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    value and slide frames if return value is True\n</span>
<span class="sd">    else\n</span>
<span class="sd">    True and slide frames if percentage of recognized slidish frames is above the threshold</span>
<span class="sd">    '''</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="s2">"slides_percentage"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"video_data"</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"video_data"</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_video</span><span class="p">(</span><span class="n">vsm</span><span class="o">=</span><span class="n">VideoSpeedManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">,</span><span class="n">COLOR_RGB</span><span class="p">),</span><span class="n">_show_info</span><span class="o">=</span><span class="n">_show_info</span><span class="p">)</span>
        <span class="n">mongo</span><span class="o">.</span><span class="n">insert_video_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"video_data"</span><span class="p">][</span><span class="s1">'slides_percentage'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">slide_frames_percent_threshold</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.request_transcript" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">request_transcript</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Downloads the transcript associated with the video and returns also whether the transcript is automatically or manually generated </p>
<p>Preferred manually generated </p>
<p>Whisper transcription is implemented in transcribe.py called as external service and will replace youtube transcript for word level precision</p>

            <details class="quote">
              <summary>Source code in <code>EVA_apps/EKEELVideoAnnotation/media/segmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">request_transcript</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">'''</span>
<span class="sd">    Downloads the transcript associated with the video and returns also whether the transcript is automatically or manually generated \n</span>
<span class="sd">    Preferred manually generated \n</span>
<span class="sd">    Whisper transcription is implemented in transcribe.py called as external service and will replace youtube transcript for word level precision\n</span>
<span class="sd">    '''</span>

    <span class="k">if</span> <span class="s2">"transcript_data"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">return</span>

    <span class="c1"># moved as external service</span>
    <span class="c1">#if extract_from_audio:</span>
    <span class="c1">#    self.data["transcript_data"] = {"text": WhisperTranscriber.transcribe(self.video_id,language), </span>
    <span class="c1">#                                    "is_autogenerated": True,</span>
    <span class="c1">#                                    "is_whisper_transcribed": True }</span>
    <span class="c1">#    mongo.insert_video_data(self.data)</span>
    <span class="c1">#    return</span>


    <span class="n">language</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_language</span><span class="p">()</span> 
    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"is_whisper_transcribed"</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

    <span class="n">transcripts</span> <span class="o">=</span> <span class="n">YTTranscriptApi</span><span class="o">.</span><span class="n">list_transcripts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_id</span><span class="p">)</span>
    <span class="n">transcript</span><span class="p">:</span><span class="n">Transcript</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">transcript</span> <span class="o">=</span> <span class="n">transcripts</span><span class="o">.</span><span class="n">find_manually_created_transcript</span><span class="p">([</span><span class="n">language</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">][</span><span class="s2">"is_autogenerated"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">transcript</span> <span class="o">=</span> <span class="n">transcripts</span><span class="o">.</span><span class="n">find_generated_transcript</span><span class="p">([</span><span class="n">language</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">][</span><span class="s2">"is_autogenerated"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">subs_dict</span> <span class="o">=</span> <span class="n">transcript</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subs_dict</span><span class="p">:</span> <span class="n">sub</span><span class="p">[</span><span class="s2">"end"</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[</span><span class="s2">"start"</span><span class="p">]</span> <span class="o">+</span> <span class="n">sub</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"duration"</span><span class="p">)</span>

    <span class="n">timed_subtitles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">subs_dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">"["</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="s2">"text"</span><span class="p">]:</span>
            <span class="n">word</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"word"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span>
                    <span class="s2">"start"</span><span class="p">:</span><span class="n">entry</span><span class="p">[</span><span class="s2">"start"</span><span class="p">],</span>
                    <span class="s2">"end"</span><span class="p">:</span> <span class="n">entry</span><span class="p">[</span><span class="s2">"end"</span><span class="p">]}</span>
            <span class="n">words</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">word_text</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="s2">"text"</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" "</span><span class="p">):</span>
                <span class="n">apostrophed_words</span> <span class="o">=</span> <span class="n">word_text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"'"</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">apostrophed_words</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">word</span><span class="p">[</span><span class="s2">"word"</span><span class="p">]</span> <span class="o">=</span> <span class="n">apostrophed_words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s2">"'"</span>
                    <span class="n">words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">apostrophed_words</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">word</span><span class="p">[</span><span class="s2">"word"</span><span class="p">]</span> <span class="o">=</span> <span class="n">apostrophed_words</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
            <span class="n">segment</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'text'</span><span class="p">:</span> <span class="n">entry</span><span class="p">[</span><span class="s2">"text"</span><span class="p">],</span> 
                       <span class="s1">'start'</span><span class="p">:</span> <span class="n">entry</span><span class="p">[</span><span class="s1">'start'</span><span class="p">],</span>
                       <span class="s1">'end'</span><span class="p">:</span> <span class="n">entry</span><span class="p">[</span><span class="s1">'end'</span><span class="p">],</span>
                       <span class="s1">'words'</span><span class="p">:</span> <span class="n">words</span> <span class="p">}</span>
            <span class="n">timed_subtitles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">][</span><span class="s2">"text"</span><span class="p">]</span> <span class="o">=</span> <span class="n">timed_subtitles</span> 

    <span class="n">mongo</span><span class="o">.</span><span class="n">insert_video_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="/home/runner/work/ekeel/ekeel/EVA_apps.EKEELVideoAnnotation.media.segmentation.VideoAnalyzer.transcript_segmentation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">transcript_segmentation</span><span class="p">(</span><span class="n">c_threshold</span><span class="o">=</span><span class="mf">0.22</span><span class="p">,</span> <span class="n">sec_min</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span> <span class="n">S</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">frame_range</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">create_thumbnails</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>:param c_threshold: threshold per la similarità tra frasi
:param sec_min: se un segmento è minore di sec_min verrà unito con il successivo
:param S: scala per color histogram
:param frame_range: aggiustare inizio e fine dei segmenti in base a differenza nel color histogram nel frame_range
:return: segments</p>

            <details class="quote">
              <summary>Source code in <code>EVA_apps/EKEELVideoAnnotation/media/segmentation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span></pre></div></td><td class="code"><div><pre><span></span><code>    <span class="k">def</span> <span class="nf">transcript_segmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c_threshold</span><span class="o">=</span><span class="mf">0.22</span><span class="p">,</span> <span class="n">sec_min</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span> <span class="n">S</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">frame_range</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">create_thumbnails</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        :param c_threshold: threshold per la similarità tra frasi</span>
<span class="sd">        :param sec_min: se un segmento è minore di sec_min verrà unito con il successivo</span>
<span class="sd">        :param S: scala per color histogram</span>
<span class="sd">        :param frame_range: aggiustare inizio e fine dei segmenti in base a differenza nel color histogram nel frame_range</span>
<span class="sd">        :return: segments</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="s2">"video_data"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s2">"segments"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"video_data"</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> 
        <span class="n">video_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_id</span>
        <span class="n">language</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_language</span><span class="p">()</span>

        <span class="c1"># get punctuated transcription from the conll in the db</span>
        <span class="c1">#transcription:str = get_text(video_id)</span>
        <span class="c1">#if transcription is None:</span>
        <span class="c1">#    if self.timed_subtitles is None:</span>
        <span class="c1">#        self.request_transcript()</span>
<span class="c1">#</span>
        <span class="c1">#    '''Get the transcription from the subtitles'''</span>
        <span class="c1">#    transcription:str = " ".join([sub["text"] for sub in self.timed_subtitles["text"]])</span>
        <span class="c1">#    if language == Locale().get_pt1_from_full('English'):</span>
        <span class="c1">#        transcription:str = transcription.replace('\n', ' ').replace("&gt;&gt;", "") \</span>
        <span class="c1">#                                         .replace("Dr.","Dr").replace("dr.","dr") \</span>
        <span class="c1">#                                         .replace("Mr.","Mr").replace("mr.","mr")</span>
        <span class="c1">#print("Checking punctuation...")</span>
        <span class="n">semantic_transcript</span> <span class="o">=</span> <span class="n">SemanticText</span><span class="p">(</span><span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timed_sentence</span><span class="p">[</span><span class="s2">"text"</span><span class="p">]</span> <span class="k">for</span> <span class="n">timed_sentence</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">][</span><span class="s2">"text"</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="s2">"["</span> <span class="ow">in</span> <span class="n">timed_sentence</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]),</span><span class="n">language</span><span class="p">)</span>

        <span class="c1">#video = mongo.get_video(video_id)</span>

<span class="w">        </span><span class="sd">'''Divide into sentences the punctuated transcription'''</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Extracting sentences.."</span><span class="p">)</span>
        <span class="n">sentences</span> <span class="o">=</span> <span class="p">[</span><span class="n">sent</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">" ,"</span><span class="p">,</span><span class="s2">","</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">" ."</span><span class="p">,</span><span class="s2">"."</span><span class="p">)</span> <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">semantic_transcript</span><span class="o">.</span><span class="n">tokenize</span><span class="p">()]</span>

<span class="w">        </span><span class="sd">'''For each sentence, add its start and end time obtained from the subtitles'''</span>
        <span class="n">timed_sentences</span> <span class="o">=</span> <span class="n">get_timed_sentences</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"transcript_data"</span><span class="p">][</span><span class="s2">"text"</span><span class="p">],</span> <span class="n">sentences</span><span class="p">)</span>

<span class="w">        </span><span class="sd">'''Define the BERT model for similarity'''</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Creating embeddings.."</span><span class="p">)</span>
        <span class="c1">#model = SentenceTransformer('paraphrase-distilroberta-base-v1')</span>
        <span class="c1">#model = SentenceTransformer('stsb-roberta-large')</span>

<span class="w">        </span><span class="sd">'''Compute a vector of numbers (the embedding) to idenfity each sentence'''</span>
        <span class="c1">#embeddings = model.encode(sentences, convert_to_tensor=True)</span>
        <span class="c1"># All moved inside semantic transcript class</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="n">semantic_transcript</span><span class="o">.</span><span class="n">get_embeddings</span><span class="p">()</span>

<span class="w">        </span><span class="sd">'''Create clusters based on semantic textual similarity, using the BERT embeddings'''</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Creating initials segments.."</span><span class="p">)</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="n">create_cluster_list</span><span class="p">(</span><span class="n">timed_sentences</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">c_threshold</span><span class="p">)</span>


<span class="w">        </span><span class="sd">'''Aggregate togheter clusters shorter than 40 seconds in total'''</span>
        <span class="n">refined_clusters</span> <span class="o">=</span> <span class="n">aggregate_short_clusters</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">sec_min</span><span class="p">)</span>

        <span class="n">start_times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">end_times</span> <span class="o">=</span> <span class="p">[]</span>

<span class="w">        </span><span class="sd">'''Print the final result'''</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">refined_clusters</span><span class="p">:</span>
            <span class="n">start_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>
            <span class="n">end_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"video_data"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"segments"</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">start_times</span><span class="p">,</span> <span class="n">end_times</span><span class="p">))}</span>
        <span class="n">mongo</span><span class="o">.</span><span class="n">insert_video_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>


        <span class="nb">print</span><span class="p">(</span><span class="s2">"Reached the part of finding clusters"</span><span class="p">)</span>

<span class="w">        </span><span class="sd">'''Find and append to each cluster the 2 most relevant sentences'''</span>
        <span class="c1">#num_sentences = 2</span>
        <span class="c1">#sumy_summary(refined_clusters, num_sentences)</span>
        <span class="c1">#self.transcript = semantic_transcript</span>


<span class="w">        </span><span class="sd">'''Adjust end and start time of each cluster based on detected scene changes'''</span>
        <span class="c1">#path = Path(__file__).parent.joinpath("static", "videos", video_id)</span>
        <span class="c1">#if not create_thumbnails:</span>
        <span class="c1">#    self.data["video_data"]['segments'] = self._create_keyframes(start_times, end_times, S, frame_range, create_thumbnails=False)</span>
        <span class="c1">#    return</span>
<span class="c1">#</span>
        <span class="c1">#if not any(File.endswith(".jpg") for File in os.listdir(path)):</span>
        <span class="c1">#    self.data["video_data"]['segments'] = self._create_keyframes(start_times, end_times, S, frame_range)</span>
        <span class="c1">#else:</span>
        <span class="c1">#    print("keyframes already present")</span>
        <span class="c1">#    images = []</span>
        <span class="c1">#    for File in os.listdir(path):</span>
        <span class="c1">#        if File.endswith(".jpg"):</span>
        <span class="c1">#            images.append(File.split(".")[0])</span>
        <span class="c1">#    images.sort(key=int)</span>
        <span class="c1">#    self.images_path = ["videos/" + video_id + "/" + im + ".jpg" for im in images]</span>
        <span class="k">return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="about:void" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://ekeel.dibris.unige.it/" target="_blank" rel="noopener" title="ekeel.dibris.unige.it" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M162.4 196c4.8-4.9 6.2-5.1 36.4-5.1 27.2 0 28.1.1 32.1 2.1 5.8 2.9 8.3 7 8.3 13.6 0 5.9-2.4 10-7.6 13.4-2.8 1.8-4.5 1.9-31.1 2.1-16.4.1-29.5-.2-31.5-.8-10.3-2.9-14.1-17.7-6.6-25.3m61.4 94.5c-53.9 0-55.8.2-60.2 4.1-3.5 3.1-5.7 9.4-5.1 13.9.7 4.7 4.8 10.1 9.2 12 2.2 1 14.1 1.7 56.3 1.2l47.9-.6 9.2-1.5c9-5.1 10.5-17.4 3.1-24.4-5.3-4.7-5-4.7-60.4-4.7m223.4 130.1c-3.5 28.4-23 50.4-51.1 57.5-7.2 1.8-9.7 1.9-172.9 1.8-157.8 0-165.9-.1-172-1.8-8.4-2.2-15.6-5.5-22.3-10-5.6-3.8-13.9-11.8-17-16.4-3.8-5.6-8.2-15.3-10-22S0 420.3 0 256.3C0 93.2 0 89.7 1.8 82.6 8.1 57.9 27.7 39 53 33.4c7.3-1.6 332.1-1.9 340-.3 21.2 4.3 37.9 17.1 47.6 36.4 7.7 15.3 7-1.5 7.3 180.6.2 115.8 0 164.5-.7 170.5m-85.4-185.2c-1.1-5-4.2-9.6-7.7-11.5-1.1-.6-8-1.3-15.5-1.7-12.4-.6-13.8-.8-17.8-3.1-6.2-3.6-7.9-7.6-8-18.3 0-20.4-8.5-39.4-25.3-56.5-12-12.2-25.3-20.5-40.6-25.1-3.6-1.1-11.8-1.5-39.2-1.8-42.9-.5-52.5.4-67.1 6.2-27 10.7-46.3 33.4-53.4 62.4-1.3 5.4-1.6 14.2-1.9 64.3-.4 62.8 0 72.1 4 84.5 9.7 30.7 37.1 53.4 64.6 58.4 9.2 1.7 122.2 2.1 133.7.5 20.1-2.7 35.9-10.8 50.7-25.9 10.7-10.9 17.4-22.8 21.8-38.5 3.2-10.9 2.9-88.4 1.7-93.9"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.top", "navigation.tabs", "navigation.instant", "content.code.annotate", "content.code.copy", "content.tooltips"], "search": "../../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.60a45f97.min.js"></script>
      
    
  </body>
</html>